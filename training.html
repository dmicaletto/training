<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano di allenamento per Laura Corridoni</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile di base e font Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #ffffff;
        }
        /* Stile per l'input focalizzato */
        input:focus {
            --tw-ring-color: #3b82f6;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.activeDay = 'day_1'; // Giorno attivo di default
        window.isPersistenceEnabled = false; // Nuovo flag per tracciare la persistenza

        // Struttura degli allenamenti (DATI MOCK AGGIORNATI)
        window.workoutDays = {
            'day_1': {
                name: "Giorno 1: Petto e Tricipiti",
                exercises: [
                    // NOTA SULLE IMMAGINI: Per poter essere visualizzate, gli URL devono puntare direttamente a file immagine pubblici, 
                    // NON a link di visualizzazione privati di Google Drive o simili che richiedono autenticazione.
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO' },
                    { name: "Chest Press distensioni delle braccia", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 20, imageUrl: './images/chestpress.png?text=CHEST+PRESS' },
                    { name: "Pectoral Machine Adduzioni delle braccia", sets: 3, reps: "10-12", rest: "90s", defaultWeight: 20, imageUrl: './images/pectoral.png?text=PECTORAL+FLY' },
                    { name: "French Press (Manubri)", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 6, imageUrl: './images/french-press.png?text=PECTORAL+FLY?text=FRENCH+PRESS' },
                    { name: "Spinte in Basso (Pushdown)", sets: 3, reps: "10-15", rest: "60s", defaultWeight: 10, imageUrl: './images/pushdown.png?text=TRICIPITI+PUSH' },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI' },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH' },
                ]
            },
            'day_2': {
                name: "Giorno 2: Schiena e Bicipiti",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO' },
                    { name: "Lat Machine", sets: 4, reps: "8-10", rest: "90s", defaultWeight: 50, imageUrl: './images/lat-machine.png?text=LAT+MACHINE' },
                    { name: "Pulley basso con Triangolo", sets: 3, reps: "10-12 (per braccio)", rest: "60s", defaultWeight: 20, imageUrl: './images/pulley-basso.png?text=REMATORE' },
                    { name: "Curl seduto con Manubri", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 25, imageUrl: './images/curl-manubri-seduto-bg.png?text=CURL+BILANCIERE' },
                    { name: "Curl a Martello ai Cavi", sets: 3, reps: "10-15", rest: "60s", defaultWeight: 10, imageUrl: './images/hammer-curl.png?text=CURL+HAMMER' },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI' },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH' },
                ]
            },
            'day_3': {
                name: "Giorno 3: Gambe e Spalle",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO' },
                    { name: "Leg Press", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/leg-press.png?text=LEG+PRESS' },
                    { name: "Leg Extension", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/legext.png?text=LEG+EXT' },
                    { name: "Leg Curl Sdraiato", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: '/images/leg-curl-sdraiato-bg.png?text=LEG+CURL' },
                    { name: "Adduzioni", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 15, imageUrl: './images/adductor.jpg?text=ADDUCTOR' },
                    { name: "Alzate Laterali", sets: 3, reps: "12", rest: "60s", defaultWeight: 8, imageUrl: './images/alzate-laterali.png?text=ALZATE+LATERALI' },
                    { name: "Alzate Frontali", sets: 3, reps: "12", rest: "60s", defaultWeight: 8, imageUrl: '/images/alzate-frontali.png?text=ALZATE+FRONTALI' },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI' },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH' },
                ]
            },
        };

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        // Configurazione Firebase: Per GitHub Pages, devi INSERIRE QUI LA TUA CONFIGURAZIONE.
        // Se lasci vuoto, l'app si caricherà ma NON salverà i dati.
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCfTXY1foD8Dr9UxRNzLeOu680aNtIw4TA",
            authDomain: "training-c0b76.firebaseapp.com",
            projectId: "training-c0b76",
            storageBucket: "training-c0b76.firebasestorage.app",
            messagingSenderId: "149618028951",
            appId: "1:149618028951:web:03756bdf1273a4521954d2"
        };


        async function initializeFirebase() {
            // Tenta di ottenere la config dalle variabili Canvas, altrimenti usa la config manuale/vuota
            let firebaseConfig;
            let initialAuthToken = null;
            let appId = 'default-app-id';

            try {
                // 1. Tenta variabili Canvas
                const canvasConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const canvasToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : appId;
                
                if (Object.keys(canvasConfig).length > 0) {
                    firebaseConfig = canvasConfig;
                    initialAuthToken = canvasToken;
                    appId = canvasAppId;
                    window.isPersistenceEnabled = true;
                    document.getElementById('status-message').textContent = 'Connesso in ambiente Canvas. La persistenza è attiva.';
                } else if (Object.keys(MANUAL_FIREBASE_CONFIG).length > 0) {
                    // 2. Usa la configurazione manuale (per GitHub Pages)
                    firebaseConfig = MANUAL_FIREBASE_CONFIG;
                    // L'ID dell'app è di solito nel config, altrimenti resta 'default-app-id'
                    window.isPersistenceEnabled = true;
                    // Prendiamo l'AppId dal projectId per l'uso in Firestore path
                    appId = firebaseConfig.projectId || 'manual-app-id';
                    window.appId = appId;
                    document.getElementById('status-message').textContent = 'Connesso al tuo progetto Firebase. La persistenza è attiva.';
                } else {
                    // 3. Nessuna configurazione trovata (modalità Solo Visualizzazione)
                    window.isPersistenceEnabled = false;
                    document.getElementById('status-message').textContent = 'ATTENZIONE: Configurazione Firebase mancante. I dati NON saranno salvati.';
                    // Esegui il rendering senza attendere l'autenticazione
                    renderDay(window.activeDay);
                    return; 
                }
                
                // --- Inizializzazione Firebase (Solo se la configurazione è valida) ---
                setLogLevel('error');
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                window.appId = appId; // Store appId globally

                // Autenticazione
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Listener per l'autenticazione
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id').textContent = `ID Utente: ${user.uid}`;
                        console.log('Firebase Initialized and User Authenticated:', window.userId);

                        // Avvia rendering e ascolto dati
                        renderDay(window.activeDay);
                        startDataListener(window.activeDay);
                    } else {
                        console.log('No user signed in.');
                        document.getElementById('status-message').textContent = 'Non autenticato. I dati non saranno salvati.';
                        window.userId = null;
                    }
                });

            } catch (error) {
                console.error("Errore durante l'inizializzazione di Firebase:", error);
                document.getElementById('status-message').textContent = 'Errore grave nell\'inizializzazione di Firebase. Persistenza disabilitata.';
                window.isPersistenceEnabled = false;
                renderDay(window.activeDay);
            }
        }

        // --- FIRESTORE DATA HANDLING ---

        function getLogDocumentRef(dayId) {
            if (!window.userId || !window.db || !window.isPersistenceEnabled) return null;
            // Usiamo window.appId che è stato impostato in initializeFirebase
            const appId = window.appId || 'default-app-id'; 
            const collectionPath = `artifacts/${appId}/users/${window.userId}/workout_logs`;
            return doc(window.db, collectionPath, dayId);
        }

        /**
         * Real-time listener for the currently active day's data.
         * @param {string} dayId - e.g., 'day_1'
         */
        function startDataListener(dayId) {
            if (!window.db || !window.userId || !window.isPersistenceEnabled) return;

            const docRef = getLogDocumentRef(dayId);
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loggedData = docSnap.data();
                    console.log(`Dati per ${dayId} caricati da Firestore:`, loggedData);
                    // Merge logged data into the current workout structure
                    const currentDay = window.workoutDays[dayId];
                    if (currentDay) {
                        currentDay.exercises = currentDay.exercises.map((exercise, exIndex) => {
                            const loggedExercise = loggedData.exercises && loggedData.exercises[exIndex] ? loggedData.exercises[exIndex] : {};
                            return {
                                ...exercise,
                                logged_weights: loggedExercise.logged_weights || {},
                            };
                        });
                        renderDay(dayId);
                    }
                } else {
                    console.log(`Nessun log trovato per ${dayId}.`);
                    // If no document exists, initialize it in the UI with empty logs
                    const currentDay = window.workoutDays[dayId];
                    if (currentDay) {
                        currentDay.exercises = currentDay.exercises.map(exercise => ({
                            ...exercise,
                            logged_weights: {}
                        }));
                        renderDay(dayId);
                    }
                }
            }, (error) => {
                console.error("Errore onSnapshot:", error);
                document.getElementById('status-message').textContent = 'Errore nel caricamento dei dati in tempo reale.';
            });
        }

        /**
         * Saves a single weight entry to Firestore.
         * @param {string} dayId - e.g., 'day_1'
         * @param {number} exIndex - Index of the exercise in the array
         * @param {number} setIndex - Index of the set (0-based)
         * @param {number|string} weight - The weight value
         */
        async function saveWeight(dayId, exIndex, setIndex, weight) {
            if (!window.isPersistenceEnabled) {
                 document.getElementById('status-message').textContent = 'ATTENZIONE: La persistenza è disabilitata. Inserisci la tua config Firebase.';
                 return;
            }

            const docRef = getLogDocumentRef(dayId);
            if (!docRef || !window.userId) {
                document.getElementById('status-message').textContent = 'Errore: Utente non autenticato o DB non pronto.';
                return;
            }

            try {
                const currentDay = window.workoutDays[dayId];
                if (!currentDay) throw new Error("Giorno di allenamento non trovato.");

                // Create a deep copy of the structure for safe modification
                let updatedExercises = JSON.parse(JSON.stringify(currentDay.exercises));

                // Update the specific weight
                const setKey = `set_${setIndex + 1}`;
                updatedExercises[exIndex].logged_weights = updatedExercises[exIndex].logged_weights || {};
                
                // Convert weight to float, use null if empty string
                const weightValue = (weight === '' || weight === null) ? null : parseFloat(weight);

                updatedExercises[exIndex].logged_weights[setKey] = weightValue;

                // Prepare the full document structure to save
                const dataToSave = {
                    dayId: dayId,
                    dayName: currentDay.name,
                    exercises: updatedExercises.map(ex => ({
                        name: ex.name,
                        sets: ex.sets,
                        reps: ex.reps,
                        rest: ex.rest,
                        defaultWeight: ex.defaultWeight,
                        imageUrl: ex.imageUrl,
                        logged_weights: ex.logged_weights // Save logged weights
                    }))
                };

                await setDoc(docRef, dataToSave, { merge: true });
                document.getElementById('status-message').textContent = 'Peso salvato con successo!';

            } catch (error) {
                console.error("Errore nel salvataggio del peso:", error);
                document.getElementById('status-message').textContent = `Errore di salvataggio: ${error.message}`;
            }
        }

        // --- GEMINI AI INTEGRATION ---

        /**
         * Chiama l'API di Gemini per generare un consiglio sull'esecuzione dell'esercizio.
         * @param {string} exerciseName - Nome dell'esercizio.
         * @param {HTMLElement} exerciseElement - Elemento DOM dove mostrare il risultato.
         */
        async function generateExerciseTip(exerciseName, exerciseElement) {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE"; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Messaggio di caricamento e disabilita il pulsante
            const button = document.getElementById(`tip-btn-${exerciseElement.id.replace('tip-output-', '')}`);
            if (button) button.disabled = true;

            exerciseElement.innerHTML = '<span class="text-yellow-400">Analisi in corso... ✨</span>';

            const systemPrompt = "Sei un personal trainer esperto e conciso. Fornisci un breve consiglio in italiano sulla corretta esecuzione dell'esercizio e indica i principali muscoli coinvolti, massimo 100 parole.";
            const userQuery = `Fornisci un consiglio per l'esercizio: ${exerciseName}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Nessun consiglio generato.';
                
                exerciseElement.innerHTML = `<p class="text-sm text-gray-300 whitespace-pre-wrap">${text}</p>`;

            } catch (error) {
                console.error("Errore Gemini API:", error);
                exerciseElement.innerHTML = `Errore API: Impossibile generare il consiglio. Riprova più tardi.`;
            } finally {
                if (button) button.disabled = false;
            }
        }
        window.generateExerciseTip = generateExerciseTip; // Expose globally


        // --- UTILITY FUNCTIONS ---

        /**
         * Restituisce l'URL dell'immagine per un esercizio.
         * @param {object} exercise - L'oggetto esercizio con il campo imageUrl.
         */
        function getImageUrl(exercise) {
             /* * NOTA IMPORTANTE SULLE IMMAGINI:
             * L'URL deve essere un link diretto ad un file immagine pubblico. 
             * I link di Google Drive per la visualizzazione privata non funzionano qui.
             */
            return exercise.imageUrl || `https://placehold.co/400x200/222222/ffffff/png?text=IMMAGINE+PER+${encodeURIComponent(exercise.name.toUpperCase().replace(/\s/g, '+'))}`;
        }

        // --- TIMER/CRONOMETER LOGIC ---

        // Mappa per tenere traccia dei timer attivi per ID esercizio
        let activeTimers = {};

        function getRestTimeSeconds(restString) {
            // Estrae il primo numero dalla stringa (es. '90s' -> 90, '60-75s' -> 60)
            const match = restString.match(/(\d+)/);
            return match ? parseInt(match[1], 10) : 0; // Default 0s se non trovato
        }

        /**
         * Aggiorna il display del timer per un esercizio specifico.
         * @param {string} timerId - ID univoco del timer (es. 'day_1-ex_0')
         * @param {number} seconds - Secondi rimanenti
         * @param {number} initialDuration - Durata iniziale del riposo
         */
        function updateTimerDisplay(timerId, seconds, initialDuration) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const displayElement = document.getElementById(timerId);
            
            if (!displayElement) return;

            displayElement.textContent = display;

            // Aggiorna lo stato del pulsante
            const button = document.getElementById(timerId.replace('timer-display', 'timer-button'));
            if (button) {
                if (activeTimers[timerId].isRunning) {
                    button.textContent = `Pausa (${display})`;
                    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    button.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                } else {
                    // Quando in pausa o terminato, mostra 'Avvia Riposo'
                    button.textContent = 'Avvia Riposo';
                    button.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                }
            }

            // Visual indicator for rest time
            if (seconds <= 5 && seconds > 0) {
                 displayElement.classList.add('text-red-500');
            } else {
                displayElement.classList.remove('text-red-500');
            }
            
            if (seconds <= 0) {
                displayElement.classList.add('font-bold');
                displayElement.textContent = '00:00 - FINE!';
            } else {
                displayElement.classList.remove('font-bold');
            }
        }

        /**
         * Avvia o ripristina un timer per un esercizio specifico.
         */
        function startTimer(dayId, exIndex, restString) {
            const timerId = `timer-display-${dayId}-${exIndex}`;
            const durationSeconds = getRestTimeSeconds(restString);

            if (durationSeconds <= 0) {
                document.getElementById('status-message').textContent = `Nessun tempo di riposo specificato per questo esercizio.`;
                return;
            }

            // Cancella eventuali timer globali o precedenti per questo ID
            if (activeTimers[timerId] && activeTimers[timerId].interval) {
                clearInterval(activeTimers[timerId].interval);
            }
            
            // Inizializza o ripristina lo stato
            activeTimers[timerId] = {
                seconds: durationSeconds,
                isRunning: true,
                initialDuration: durationSeconds,
                interval: null,
            };

            const interval = setInterval(() => {
                activeTimers[timerId].seconds--;
                const remainingSeconds = activeTimers[timerId].seconds;

                updateTimerDisplay(timerId, remainingSeconds, durationSeconds);

                if (remainingSeconds <= 0) {
                    clearInterval(interval);
                    activeTimers[timerId].isRunning = false;
                    // Mostra un messaggio di stato globale solo per la fine del timer
                    document.getElementById('status-message').textContent = `RIPOSO TERMINATO per ${window.workoutDays[dayId].exercises[exIndex].name}!`;
                    updateTimerDisplay(timerId, 0, durationSeconds); // Aggiorna a 00:00 - FINE!
                }
            }, 1000);
            
            activeTimers[timerId].interval = interval;
            document.getElementById('status-message').textContent = `Riposo di ${durationSeconds} secondi per ${window.workoutDays[dayId].exercises[exIndex].name} iniziato.`;
            updateTimerDisplay(timerId, durationSeconds, durationSeconds);
        }

        /**
         * Toggle pausa/ripristino per il timer di un esercizio specifico.
         */
        function toggleTimer(dayId, exIndex, restString) {
            const timerId = `timer-display-${dayId}-${exIndex}`;
            const durationSeconds = getRestTimeSeconds(restString);

            if (durationSeconds <= 0) {
                document.getElementById('status-message').textContent = `Nessun tempo di riposo specificato per questo esercizio.`;
                return;
            }

            if (!activeTimers[timerId] || activeTimers[timerId].seconds <= 0) {
                // Se non è attivo o è finito, lo fa ripartire dalla durata iniziale
                startTimer(dayId, exIndex, restString);
                return;
            }

            if (activeTimers[timerId].isRunning) {
                // Metti in pausa
                clearInterval(activeTimers[timerId].interval);
                activeTimers[timerId].isRunning = false;
                document.getElementById('status-message').textContent = 'Timer in Pausa.';
            } else {
                // Riprendi
                activeTimers[timerId].isRunning = true;
                document.getElementById('status-message').textContent = 'Timer ripreso.';
                const interval = setInterval(() => {
                    activeTimers[timerId].seconds--;
                    updateTimerDisplay(timerId, activeTimers[timerId].seconds, durationSeconds);
                    if (activeTimers[timerId].seconds <= 0) {
                        clearInterval(interval);
                        activeTimers[timerId].isRunning = false;
                    }
                }, 1000);
                activeTimers[timerId].interval = interval;
            }
            updateTimerDisplay(timerId, activeTimers[timerId].seconds, durationSeconds);
        }
        
        // Expose to the global scope for button click handlers
        window.startTimer = startTimer;
        window.toggleTimer = toggleTimer;


        // --- UI RENDERING ---

        function switchDay(newDayId) {
            if (window.activeDay === newDayId) return;
            window.activeDay = newDayId;
            renderDay(newDayId);
            startDataListener(newDayId); // Start listener for the new day
            // Update tab styles
            document.querySelectorAll('.day-tab').forEach(tab => {
                if (tab.dataset.day === newDayId) {
                    tab.classList.remove('text-gray-400', 'border-transparent');
                    tab.classList.add('text-white', 'border-blue-500', 'bg-gray-700');
                } else {
                    tab.classList.remove('text-white', 'border-blue-500', 'bg-gray-700');
                    tab.classList.add('text-gray-400', 'border-transparent');
                }
            });
        }

        function renderDay(dayId) {
            const dayData = window.workoutDays[dayId];
            const contentDiv = document.getElementById('workout-content');

            if (!dayData) {
                contentDiv.innerHTML = '<p class="text-red-500">Giorno di allenamento non trovato.</p>';
                return;
            }

            let html = `<h2 class="text-3xl font-bold mb-6 text-blue-400">${dayData.name}</h2>`;

            dayData.exercises.forEach((exercise, exIndex) => {
                // Parse rest time for timer logic
                const restSeconds = getRestTimeSeconds(exercise.rest);
                const timerId = `timer-display-${dayId}-${exIndex}`;
                
                // Determina se l'esercizio è a tempo (Cardio/Stretching) o a serie (Peso)
                const isTimedExercise = exercise.sets === 0 || exercise.rest === "N/A" || !exercise.sets;

                // Card Esercizio
                html += `
                <div class="bg-gray-800 p-4 mb-6 rounded-xl shadow-lg border border-gray-700">
                    <!-- Intestazione Esercizio e Immagine -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-shrink-0 w-full md:w-1/3">
                            <img src="${getImageUrl(exercise)}" alt="Immagine di ${exercise.name}"
                                 onerror="this.onerror=null; this.src='https://placehold.co/400x200/800080/ffffff/png?text=LINK+NON+PUBBLICO!+Carica+un+link+diretto';"
                                 class="w-full h-auto object-cover rounded-lg border border-gray-600">
                                 <!-- L'onerror fallback mostra un messaggio esplicito se l'immagine fallisce -->
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-xl font-semibold mb-1 text-white">${exercise.name}</h3>
                            <p class="text-sm text-gray-400">Ripetizioni: <span class="text-blue-300">${exercise.reps}</span></p>
                            
                            <!-- Timer di Riposo/Durata e Bottone (Solo per esercizi a serie) -->
                            ${!isTimedExercise ? `
                                <p class="text-sm text-gray-400">Recupero: <span class="text-yellow-300">${exercise.rest}</span></p>
                                <div class="mt-3 flex items-center gap-3">
                                    <button id="timer-button-${dayId}-${exIndex}" 
                                            onclick="window.toggleTimer('${dayId}', ${exIndex}, '${exercise.rest}')"
                                            class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex-grow md:flex-grow-0">
                                        Avvia Riposo
                                    </button>
                                    <span id="${timerId}" class="text-4xl font-mono tracking-wider text-white flex-shrink-0">
                                        ${String(Math.floor(restSeconds / 60)).padStart(2, '0')}:${String(restSeconds % 60).padStart(2, '0')}
                                    </span>
                                </div>
                            ` : `
                                <p class="text-sm text-gray-400 mt-2">Modalità: <span class="text-green-400 font-medium">Continuo / Durata</span></p>
                            `}
                        </div>
                    </div>

                    <!-- Integrazione Gemini AI Tip -->
                    <div class="mt-4 flex flex-col md:flex-row gap-4 items-start">
                        <button id="tip-btn-${dayId}-${exIndex}" 
                                onclick="generateExerciseTip('${exercise.name}', document.getElementById('tip-output-${dayId}-${exIndex}'))"
                                class="w-full md:w-auto flex-shrink-0 px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                            ✨ Chiedi un Tip sull'Esecuzione
                        </button>
                        <div id="tip-output-${dayId}-${exIndex}" class="p-3 bg-gray-900 rounded-lg flex-grow text-gray-400 w-full">
                            <!-- Il tip del Personal Trainer AI apparirà qui -->
                            <span class="text-xs">Clicca per un consiglio sul corretto svolgimento.</span>
                        </div>
                    </div>


                    <!-- Log Pesi per Serie (Solo per esercizi a serie) -->
                    ${!isTimedExercise ? `
                        <div class="mt-4 border-t border-gray-700 pt-4">
                            <p class="font-medium mb-2 text-gray-300">Log Pesi (in kg):</p>
                            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                    ` : ''}
                `;

                if (!isTimedExercise) {
                    for (let setIndex = 0; setIndex < exercise.sets; setIndex++) {
                        const setKey = `set_${setIndex + 1}`;
                        // USA defaultWeight se non c'è il logged_weight
                        const currentWeight = (exercise.logged_weights && exercise.logged_weights[setKey] !== undefined && exercise.logged_weights[setKey] !== null)
                            ? exercise.logged_weights[setKey]
                            : exercise.defaultWeight || ''; 

                        html += `
                            <div class="flex flex-col">
                                <label for="${dayId}-${exIndex}-${setIndex}" class="text-xs font-semibold mb-1 text-yellow-400">Serie ${setIndex + 1} (R: ${exercise.reps})</label>
                                <input type="number" step="0.5" value="${currentWeight}"
                                       onchange="window.saveWeight('${dayId}', ${exIndex}, ${setIndex}, this.value)"
                                       id="${dayId}-${exIndex}-${setIndex}"
                                       class="w-full p-2 text-base text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                       placeholder="Peso (kg)">
                            </div>
                        `;
                    }
                }

                html += `
                    ${!isTimedExercise ? `
                            </div>
                        </div>
                    ` : ''}
                </div>
                `;
            });

            contentDiv.innerHTML = html;
        }
        
        // Expose to the global scope for tab switching
        window.switchDay = switchDay;

        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            // Render tabs
            const tabsContainer = document.getElementById('day-tabs');
            let tabsHtml = '';
            let isFirst = true;
            for (const [dayId, data] of Object.entries(window.workoutDays)) {
                const activeClasses = isFirst ? 'text-white border-blue-500 bg-gray-700' : 'text-gray-400 border-transparent';
                tabsHtml += `
                    <button class="day-tab flex-1 py-3 text-sm font-medium border-b-2 ${activeClasses} transition duration-300 hover:border-blue-500 hover:text-white"
                            data-day="${dayId}" onclick="window.switchDay('${dayId}')">
                        ${data.name.split(':')[0]}
                    </button>
                `;
                isFirst = false;
            }
            tabsContainer.innerHTML = tabsHtml;

            // Initialize Firebase and start everything
            initializeFirebase();
        });
    </script>
</head>
<body class="min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-4xl font-extrabold text-blue-500 tracking-tight">
                💪 Piano di allenamento Laura
            </h1>
            <p class="text-gray-400 mt-2">Programma di 3 giorni con tracciamento pesi in tempo reale.</p>
        </header>

        <!-- Status and User ID -->
        <div class="mb-6 p-3 bg-gray-900 rounded-xl border border-gray-700 text-center">
            <!-- Messaggio di stato aggiornato per la modalità senza persistenza -->
            <p id="status-message" class="text-sm font-medium text-green-400">Inizializzazione in corso...</p>
            <p id="user-id" class="text-xs text-gray-500 mt-1"></p>
        </div>
        
        
        <!-- Tabs for Days -->
        <div id="day-tabs" class="flex justify-around bg-gray-900 rounded-t-xl overflow-hidden border-b-2 border-gray-700 mb-6">
            <!-- Tabs will be rendered here by JavaScript -->
        </div>

        <!-- Workout Content Area -->
        <div id="workout-content" class="min-h-[500px] p-2">
            <p class="text-center text-gray-500 pt-20">Caricamento del programma...</p>
        </div>

    </div>
</body>
</html>
