<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano di allenamento per Laura Corridoni</title>
	<!-- ... dopo il <title> -->
	<script src="https://cdn.tailwindcss.com"></script>
	
	<!-- META TAG PWA E TEMA -->
	<meta name="theme-color" content="#0d1117">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Gym App">
	
	<!-- LINK AL MANIFEST (che ho creato io) -->
	<link rel="manifest" href="manifest.json">
	
	<!-- ICONA PER iOS (Apple) -->
	<link rel="apple-touch-icon" href="./images/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Stile di base e font Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #ffffff;
        }
        /* Stile per l'input focalizzato */
        input:focus {
            --tw-ring-color: #3b82f6;
        }
        /* Stile per il Modale */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal.hidden .modal-content {
            transform: translateY(-50px);
        }
		/* STILI AGGIUNTIVI PER MENU LATERALE */
        .off-canvas {
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        .off-canvas.active {
            transform: translateX(0);
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // AGGIORNATO: Aggiunte getDocs, query, orderBy
		import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabili Globali
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.activeDay = 'day_1'; // Giorno attivo di default
        window.isPersistenceEnabled = false; // Flag per tracciare la persistenza
        
        // Nuove variabili per la ModalitÃ  Guidata
        window.isGuidedMode = false;
        window.currentExIndex = 0; // Indice dell'esercizio corrente (0-based)
        window.currentSet = 1;      // Numero della serie corrente (1-based)
        window.unsubscribeListener = null; // Per pulire il listener Firestore

		// Variabili per Cronometro Totale e Tonnellaggio
        window.totalTimeSeconds = 0;
        window.totalTimerInterval = null;
        window.totalTonnage = 0; 
        window.exerciseTonnageMap = {}; 
		window.totalCalories = 0; // NUOVO: Calorie totali stimate
		window.currentWorkoutRating = 0; // Per la valutazione (da 1 a 5)
		window.chartTimeRange = 'week'; // Valore di default: 'week' o 'month'
        
        // DATI DEL PROFILO UTENTE
        window.userProfile = {
            name: 'Laura',
            surname: 'Corridoni',
            age: 50,
            weight: 46,
            sex: 'F' 
        };


        // Struttura degli allenamenti (DATI MOCK AGGIORNATI CON NOTE DI DEFAULT)
        window.workoutDays = {
            'day_1': {
                name: "Giorno 1: Petto e Tricipiti",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO', notes: "Mantieni un ritmo moderato che ti consenta di parlare." },
                    { name: "Chest Press distensioni delle braccia", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 20, imageUrl: './images/chestpress.png?text=CHEST+PRESS', notes: "Spingi i gomiti in avanti. Contrai il petto al massimo accorciamento." },
                    { name: "Pectoral Machine Adduzioni delle braccia", sets: 3, reps: "10-12", rest: "90s", defaultWeight: 20, imageUrl: './images/pectoral.png?text=PECTORAL+FLY', notes: "Mantieni le spalle basse e concentratevi solo sulla contrazione del petto." },
                    { name: "French Press (Manubri)", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 6, imageUrl: './images/french-press.png?text=PECTORAL+FLY?text=FRENCH+PRESS', notes: "Movimento controllato, senti l'allungamento. Usa un peso moderato." },
                    { name: "Spinte in Basso (Pushdown)", sets: 3, reps: "10-15", rest: "60s", defaultWeight: 10, imageUrl: './images/pushdown.png?text=TRICIPITI+PUSH', notes: "Porta il cavo fino in fondo. Contrai il tricipite alla massima estensione." },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI', notes: "Esegui lentamente con controllo. Non forzare l'estensione." },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH', notes: "Concentrati sull'avvicinare lo sterno al bacino, non sul collo." },
                ]
            },
            'day_2': {
                name: "Giorno 2: Schiena e Bicipiti",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO', notes: "Mantieni un ritmo moderato che ti consenta di parlare." },
                    { name: "Lat Machine", sets: 4, reps: "8-10", rest: "90s", defaultWeight: 50, imageUrl: './images/lat-machine.png?text=LAT+MACHINE', notes: "Tira con i gomiti, non con i bicipiti. Schiena dritta." },
                    { name: "Pulley basso con Triangolo", sets: 3, reps: "10-12 (per braccio)", rest: "60s", defaultWeight: 20, imageUrl: './images/pulley-basso.png?text=REMATORE', notes: "Petto in fuori, schiena inarcata. Porta il triangolo all'ombelico." },
                    { name: "Curl seduto con Manubri", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 25, imageUrl: './images/curl-manubri-seduto-bg.png?text=CURL+BILANCIERE', notes: "Ruota il polso (supinazione) durante la salita. Non oscillare." },
                    { name: "Curl a Martello ai Cavi", sets: 3, reps: "10-15", rest: "60s", defaultWeight: 10, imageUrl: './images/hammer-curl.png?text=CURL+HAMMER', notes: "Focus sull'avambraccio. Presa neutra e stretta." },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI', notes: "Esegui lentamente con controllo. Non forzare l'estensione." },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH', notes: "Concentrati sull'avvicinare lo sterno al bacino, non sul collo." },
                ]
            },
            'day_3': {
                name: "Giorno 3: Gambe e Spalle",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO', notes: "Mantieni un ritmo moderato che ti consenta di parlare." },
                    { name: "Leg Press", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/leg-press.png?text=LEG+PRESS', notes: "Non bloccare le ginocchia in alto. Spingi con i talloni." },
                    { name: "Leg Extension", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/legext.png?text=LEG+EXT', notes: "Contrai il quadricipite per un secondo al massimo accorciamento." },
                    { name: "Leg Curl Sdraiato", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/leg-curl-sdraiato-bg.png?text=LEG+CURL', notes: "Focus sui femorali. Movimento lento in fase negativa." },
                    { name: "Adduzioni", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 15, imageUrl: './images/adductor.png?text=ADDUCTOR', notes: "Siediti in modo da isolare solo gli adduttori. Controlla il ritorno." },
                    { name: "Alzate Laterali", sets: 3, reps: "12", rest: "60s", defaultWeight: 8, imageUrl: './images/alzate-laterali.png?text=ALZATE+LATERALI', notes: "Gomiti leggermente flessi. Porta i manubri all'altezza delle spalle, non piÃ¹ su." },
                    { name: "Alzate Frontali", sets: 3, reps: "12", rest: "60s", defaultWeight: 8, imageUrl: './images/alzate-frontali.png?text=ALZATE+FRONTALI', notes: "Solleva alternando le braccia o entrambe insieme. Movimento controllato." },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI', notes: "Esegui lentamente con controllo. Non forzare l'estensione." },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH', notes: "Concentrati sull'avvicinare lo sterno al bacino, non sul collo." },
                ]
            },
        };
		// NUOVE FUNZIONI: Controllo Menu Laterale (Off-Canvas)
		function openMenu() {
		    document.getElementById('off-canvas-menu').classList.remove('hidden');
		    // Forziamo il reflow e poi attiviamo la transizione
		    setTimeout(() => {
		        document.getElementById('off-canvas-menu').classList.add('active');
		    }, 10); 
		}
		window.openMenu = openMenu;
		
		function closeMenu() {
		    document.getElementById('off-canvas-menu').classList.remove('active');
		    // Aspetta che l'animazione finisca (0.3s) prima di nascondere completamente
		    setTimeout(() => {
		        document.getElementById('off-canvas-menu').classList.add('hidden');
		    }, 300); 
		}
		window.closeMenu = closeMenu;
		
		// ... (Le funzioni openProfileModal, closeProfileModal, openHistoryModal, closeHistoryModal restano come sono, ma verranno chiamate dal menu)
		// --- Riscriviamo openHistoryModal e openProfileModal per chiudere il menu ---
		function openProfileModal() {
		    closeMenu(); // Chiude il menu laterale
		    const modal = document.getElementById('profile-modal');
		    modal.classList.remove('hidden');
		    renderProfileContent();
		}
		window.openProfileModal = openProfileModal;
		
		function openHistoryModal() {
		    closeMenu(); // Chiude il menu laterale
		    const modal = document.getElementById('history-modal');
		    modal.classList.remove('hidden');
		    loadAndRenderHistory(); // Avvia il caricamento dei dati
		}
		window.openHistoryModal = openHistoryModal;
		
		function closeProfileModal() {
		    document.getElementById('profile-modal').classList.add('hidden');
		}
		window.closeProfileModal = closeProfileModal;
		
		function closeHistoryModal() {
		    document.getElementById('history-modal').classList.add('hidden');
		}
		window.closeHistoryModal = closeHistoryModal;


		/**
		 * Carica lo storico degli allenamenti da Firestore e lo renderizza.
		 */
		async function loadAndRenderHistory() {
		    const historyColRef = getHistoryCollectionRef();
		    const historyContentDiv = document.getElementById('history-content');
		    historyContentDiv.innerHTML = '<p class="text-center text-yellow-400">Caricamento storico in corso...</p>';
		    
		    if (!historyColRef) {
		        historyContentDiv.innerHTML = '<p class="text-center text-red-500">Errore: Persistenza non attiva o utente non loggato.</p>';
		        return;
		    }
		
			try {
			    // CORREZIONE: Usiamo query e orderBy per ottenere i documenti ordinati.
			    // Ordina per data (decrescente)
			    const historyQuery = query(historyColRef, orderBy("date", "desc"), orderBy("endTime", "desc"));
			
			    const querySnapshot = await getDocs(historyQuery); 
			
			    const historyData = [];
			    querySnapshot.forEach(doc => {
			        historyData.push({ id: doc.id, ...doc.data() });
			    });
				
				// --- Preparazione Dati Grafico (Dinamica) ---
				const chartDataArray = [];
				const today = new Date();
				
				if (window.chartTimeRange === 'week') {
				    // Logica Settimana (Ultimi 7 giorni)
				    const dayLabels = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
				    for (let i = 6; i >= 0; i--) {
				        const d = new Date(today);
				        d.setDate(today.getDate() - i);
				        chartDataArray.push({
				            dateString: d.toISOString().split('T')[0],
				            dayLabel: dayLabels[d.getDay()], // Etichetta: Dom, Lun...
				            totalTonnage: 0,
				            totalCalories: 0,
				            hasWorkout: false
				        });
				    }
				} else {
				    // Logica Mese (Ultimi 30 giorni)
				    for (let i = 29; i >= 0; i--) {
				        const d = new Date(today);
				        d.setDate(today.getDate() - i);
				        chartDataArray.push({
				            dateString: d.toISOString().split('T')[0],
				            // Etichetta: es. "11 nov"
				            dayLabel: d.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }), 
				            totalTonnage: 0,
				            totalCalories: 0,
				            hasWorkout: false
				        });
				    }
				}
				// --- Fine blocco preparazione dati ---
			
			    // --- Inizio HTML Lista ---
			    let listHtml = '<div class="mt-8 pt-4 border-t border-gray-600"><h4 class="text-xl font-bold text-white mb-4">Lista Allenamenti Recenti</h4><div class="space-y-4">';
			    let hasRecentHistory = false;
			
			    historyData.forEach(log => {
			        hasRecentHistory = true;
			        // Assicurati che i dati siano definiti
			        const totalTonnage = log.totalTonnage ? log.totalTonnage : 0;
			        const estimatedCalories = log.estimatedCalories ? log.estimatedCalories : 0;
			        const durationDisplay = log.durationDisplay || 'N/A';
			        const rating = log.rating || 0;
			
			        // Popolamento dati grafico
					const dayData = chartDataArray.find(d => d.dateString === log.date);
			        if (dayData) {
			            dayData.totalTonnage += totalTonnage;
			            dayData.totalCalories += estimatedCalories;
			            dayData.hasWorkout = true;
			        }
			
			        // Genera stelle per la lista
			        let starsHtml = '';
			        for (let i = 1; i <= 5; i++) {
			            starsHtml += `<span class="text-xs ${i <= rating ? 'text-yellow-400' : 'text-gray-500'}">&#9733;</span>`;
			        }
			
			        // Creazione HTML per la lista
			        listHtml += `
			            <div class="bg-gray-700 p-4 rounded-lg border border-gray-600 shadow-md">
			                <div class="flex justify-between items-start border-b border-gray-500 pb-2 mb-2">
			                    <h4 class="text-xl font-bold text-blue-300">${log.dayName}</h4>
			                    <div class="text-right">
			                        <span class="text-sm text-gray-400 block">${log.date} (${log.startTime} - ${log.endTime})</span>
			                        <div class="mt-1">${starsHtml}</div>
			                    </div>
			                </div>
			                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
			                    <p>ðŸ’ª Volume Totale: <span class="font-bold text-white">${totalTonnage.toLocaleString('it-IT')} kg</span></p>
			                    <p>ðŸ”¥ Calorie Stimate: <span class="font-bold text-red-400">${estimatedCalories.toLocaleString('it-IT')} kcal</span></p>
			                    <p>ðŸ•’ Durata: <span class="font-bold text-white">${durationDisplay}</span></p>
			                </div>
			            </div>
			        `;
			    });
			
			    if (!hasRecentHistory) {
			         listHtml += '<p class="text-center text-gray-400 p-8">Nessun allenamento trovato nello storico.</p>';
			    }
			    listHtml += '</div></div>'; // Chiusura space-y-4 e div lista
			
			    // --- Preparazione Dati e HTML Grafico ---
			    const chartDataForJson = chartDataArray.map(d => ({
			        day: d.dayLabel,
			        totalTonnage: d.totalTonnage,
			        totalCalories: d.totalCalories,
			        hasWorkout: d.hasWorkout
			    }));
			
				// Definisce lo stile per i bottoni (attivo/inattivo)
				const weekBtnClass = window.chartTimeRange === 'week' 
				    ? 'bg-blue-600 text-white' 
				    : 'bg-gray-600 text-gray-300 hover:bg-gray-500';
				const monthBtnClass = window.chartTimeRange === 'month' 
				    ? 'bg-blue-600 text-white' 
				    : 'bg-gray-600 text-gray-300 hover:bg-gray-500';

				let chartHtml = `
				    <div>
				        <div class="flex justify-between items-center mb-4">
				            <h4 class="text-xl font-bold text-white">
				                Statistiche ${window.chartTimeRange === 'week' ? 'Ultimi 7 Giorni' : 'Ultimi 30 Giorni'}
				            </h4>
				            <div class="flex space-x-2">
				                <button onclick="window.setChartTimeRange('week')" class="px-3 py-1 text-sm font-medium rounded-full transition-colors ${weekBtnClass}">
				                    Settimana
				                </button>
				                <button onclick="window.setChartTimeRange('month')" class="px-3 py-1 text-sm font-medium rounded-full transition-colors ${monthBtnClass}">
				                    Mese
				                </button>
				            </div>
				        </div>
				        <div id="weekly-chart-container" class="relative h-64 md:h-80 min-h-[250px] p-4 bg-gray-700 rounded-lg">
			                <canvas id="weeklyChart"></canvas>
			            </div>
			            <!-- Usiamo un input hidden per passare i dati JSON alla funzione di rendering del grafico -->
			            <textarea id="chart-data-dump" class="hidden">${JSON.stringify(chartDataForJson)}</textarea>
			        </div>
			    `;
			
			    // Se non ci sono dati NEGLI ULTIMI 7 GIORNI, mostra un messaggio nel grafico
			    const hasDataForChart = chartDataForJson.some(d => d.hasWorkout);
			
			    // Combina Grafico e Lista
			    historyContentDiv.innerHTML = chartHtml + listHtml;
			
			    if (hasDataForChart) {
			        renderWeeklyChart();
			    } else {
			        document.getElementById('weekly-chart-container').innerHTML = '<p class="text-center text-gray-400 p-8 flex items-center justify-center h-full">Nessun allenamento negli ultimi 7 giorni per il grafico.</p>';
			    }
			
			} catch (error) {
			    console.error("Errore nel caricamento dello storico:", error);
			    historyContentDiv.innerHTML = `<p class="text-center text-red-500 p-8">Impossibile caricare lo storico: ${error.message}.</p>`;
			}
		}
		
        /**
         * Renderizza il contenuto dinamico della modale profilo.
         */
        function renderProfileContent() {
            const container = document.getElementById('personal-info-content');
            if (!container) return;

            container.innerHTML = `
                <div class="grid grid-cols-1 gap-4">
                    <div class="flex flex-col">
                        <label for="profile-name" class="text-sm font-semibold mb-1 text-gray-400">Nome</label>
                        <input type="text" id="profile-name" value="${window.userProfile.name}"
                                onchange="window.saveUserProfile('name', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="Nome">
                    </div>
                    <div class="flex flex-col">
                        <label for="profile-surname" class="text-sm font-semibold mb-1 text-gray-400">Cognome</label>
                        <input type="text" id="profile-surname" value="${window.userProfile.surname}"
                                onchange="window.saveUserProfile('surname', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="Cognome">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="flex flex-col">
                        <label for="profile-sex" class="text-sm font-semibold mb-1 text-gray-400">Sesso</label>
                        <select id="profile-sex" 
                                onchange="window.saveUserProfile('sex', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            <option value="F" ${window.userProfile.sex === 'F' ? 'selected' : ''}>F</option>
                            <option value="M" ${window.userProfile.sex === 'M' ? 'selected' : ''}>M</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="profile-age" class="text-sm font-semibold mb-1 text-gray-400">EtÃ </label>
                        <input type="number" step="1" id="profile-age" value="${window.userProfile.age}"
                                onchange="window.saveUserProfile('age', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="00">
                    </div>
                     <div class="flex flex-col">
                        <label for="profile-weight" class="text-sm font-semibold mb-1 text-gray-400">Peso (kg)</label>
                        <input type="number" step="0.1" id="profile-weight" value="${window.userProfile.weight}"
                                onchange="window.saveUserProfile('weight', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="00.0">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-4 text-center">I dati vengono salvati automaticamente.</p>
            `;
        }

		/**
		 * Imposta l'intervallo di tempo per il grafico (settimana/mese) e ricarica i dati.
		 */
		function setChartTimeRange(range) {
		    if (window.chartTimeRange === range) return; // Non fare nulla se Ã¨ giÃ  selezionato
		    window.chartTimeRange = range;
		    
		    // Ricarica l'intero contenuto della modale per aggiornare grafico e bottoni
		    loadAndRenderHistory();
		}
		window.setChartTimeRange = setChartTimeRange;
		/**
		 * Imposta la valutazione (da 1 a 5) e aggiorna l'UI delle stelle.
		 */
		function setRating(rating) {
		    window.currentWorkoutRating = rating;
		    const stars = document.querySelectorAll('.rating-star');
		    stars.forEach((star, index) => {
		        if (index < rating) {
		            // Stella piena (gialla)
		            star.classList.remove('text-gray-600');
		            star.classList.add('text-yellow-400');
		            star.innerHTML = '&#9733;'; // Stella piena
		        } else {
		            // Stella vuota (grigia)
		            star.classList.remove('text-yellow-400');
		            star.classList.add('text-gray-600');
		            star.innerHTML = '&#9734;'; // Stella vuota
		        }
		    });
		}
		window.setRating = setRating;
        // --- GESTIONE DATI UTENTE E FIRESTORE ---

        function getLogDocumentRef(dayId) {
            if (!window.userId || !window.db || !window.isPersistenceEnabled) return null;
            // Percorso standard per dati privati in Canvas
            const appId = window.appId || 'default-app-id'; 
            const collectionPath = `artifacts/${appId}/users/${window.userId}/workout_logs`;
            return doc(window.db, collectionPath, dayId);
        }
        
        /**
         * Riferimento al documento del profilo utente (6 Segmenti).
         */
        function getProfileDocumentRef() {
            if (!window.userId || !window.db || !window.isPersistenceEnabled) return null;
            const appId = window.appId || 'default-app-id'; 
            // Percorso a 6 segmenti: C/D/C/D/C/D
            return doc(window.db, 
                       `artifacts/${appId}/users/${window.userId}/profiles_meta`, 
                       'data' // Nome del documento
                   ); 
        }
		// NUOVA FUNZIONE: Riferimento alla collezione dello storico
		function getHistoryCollectionRef() {
		    if (!window.userId || !window.db || !window.isPersistenceEnabled) return null;
		    const appId = window.appId || 'default-app-id'; 
		    // Percorso: artifacts/{appId}/users/{userId}/workout_history
		    return collection(window.db, `artifacts/${appId}/users/${window.userId}/workout_history`);
		}
        /**
         * Carica il profilo utente da Firestore o usa i default, poi aggiorna il titolo.
         */
        async function loadUserProfile() {
            const docRef = getProfileDocumentRef();
            
            if (!docRef) { 
                renderUserProfileTitle();
                return; 
            }

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const profileData = docSnap.data();
                    
                    window.userProfile = {
                        name: profileData.name || window.userProfile.name,
                        surname: profileData.surname || window.userProfile.surname,
                        weight: parseFloat(profileData.weight) || window.userProfile.weight,
                        age: parseInt(profileData.age) || window.userProfile.age,
                        sex: profileData.sex || window.userProfile.sex, 
                    };
                } else {
                     console.log("Documento profilo non trovato. Vengono usati i valori di default.");
                }
            } catch (error) {
                console.error("Errore critico nel caricamento del profilo utente, ma il rendering prosegue:", error);
            } finally {
                renderUserProfileTitle();
            }
        }
        
        /**
         * Salva e aggiorna i dati del profilo utente.
         */
        async function saveUserProfile(field, value) {
            if (!window.isPersistenceEnabled || !window.userId) {
                showTemporaryMessage('ATTENZIONE: Persistenza disabilitata. Dati NON salvati.', 'bg-red-500');
                return;
            }

            const docRef = getProfileDocumentRef();
            if (!docRef) return;
            
            // 1. Aggiorna la variabile globale (e gestisce il parsing)
            if (field === 'name') {
                window.userProfile.name = value;
            } else if (field === 'surname') {
                window.userProfile.surname = value;
            } else if (field === 'weight') {
                window.userProfile.weight = parseFloat(value) || 0; // Usiamo 0 come fallback numerico
            } else if (field === 'age') {
                window.userProfile.age = parseInt(value) || 0;
            } else if (field === 'sex') {
                window.userProfile.sex = value;
            }

            try {
                // 2. Prepara la struttura di salvataggio (assicurando che non ci siano undefined)
                const dataToSave = {
                    name: window.userProfile.name || '',
                    surname: window.userProfile.surname || '',
                    weight: window.userProfile.weight || 0,
                    age: window.userProfile.age || 0,
                    sex: window.userProfile.sex || 'X',
                }
                
                await setDoc(docRef, dataToSave, { merge: true });
                showTemporaryMessage(`Profilo aggiornato (${field} salvato)!`, 'bg-blue-600');
            } catch (error) {
                console.error("Errore nel salvataggio del profilo:", error);
                showTemporaryMessage(`Errore di salvataggio profilo: ${error.message}`, 'bg-red-500');
            }
            renderUserProfileTitle(); // Aggiorna il titolo nell'header
        }
        window.saveUserProfile = saveUserProfile;

        /**
         * Renderizza solo il titolo principale.
         */
        function renderUserProfileTitle() {
            const titleElement = document.getElementById('main-title');
            if (titleElement) {
                // Usiamo Nome e Cognome combinati
                const displayName = window.userProfile.name || window.userProfile.surname ? `${window.userProfile.name} ${window.userProfile.surname}` : 'Utente';
                titleElement.textContent = `ðŸ’ª Piano di allenamento`;
            }
        }


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        
        // ** CONFIGURAZIONE REINTRODOTTA **
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCfTXY1foD8Dr9UxRNzLeOu680aNtIw4TA",
            authDomain: "training-c0b76.firebaseapp.com",
            projectId: "training-c0b76",
            storageBucket: "training-c0b76.firebasestorage.app",
            messagingSenderId: "149618028951",
            appId: "1:149618028951:web:03756bdf1273a4521954d2"
        };
		
        async function initializeFirebase() {
            let firebaseConfig;
            let initialAuthToken = null;
            let appId = 'default-app-id';
            let persistenceAttempted = true;

            try {
                // 1. Tenta variabili Canvas (PRIORITÃ€)
                const canvasConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const canvasToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : appId;
                
                if (Object.keys(canvasConfig).length > 0) {
                    firebaseConfig = canvasConfig;
                    initialAuthToken = canvasToken;
                    appId = canvasAppId;
                    window.isPersistenceEnabled = true;
                    document.getElementById('status-message').textContent = 'Connesso (Canvas Environment). La persistenza Ã¨ attiva.';
                } else if (Object.keys(MANUAL_FIREBASE_CONFIG).length > 0) {
                    // 2. Usa la configurazione manuale (FALLBACK)
                    firebaseConfig = MANUAL_FIREBASE_CONFIG;
                    appId = firebaseConfig.projectId || 'manual-app-id';
                    window.isPersistenceEnabled = true;
                    document.getElementById('status-message').textContent = 'Connesso (Configurazione Manuale). La persistenza Ã¨ attiva.';
                } else {
                    // 3. Nessuna configurazione trovata (ModalitÃ  Solo Visualizzazione)
                    persistenceAttempted = false;
                    window.isPersistenceEnabled = false;
                    document.getElementById('status-message').textContent = 'ATTENZIONE: Persistenza disabilitata. Dati NON saranno salvati.';
                }
                
                if (!persistenceAttempted) {
                    await loadUserProfile(); // Carica il profilo di default e renderizza il titolo
                    renderDay(window.activeDay);
                    return; 
                }

                // --- Inizializzazione Firebase ---
                setLogLevel('error'); // Mostra solo errori per pulizia console
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
				// Imposta la persistenza a "local" (localStorage).
				// Questo manterrÃ  l'utente anonimo loggato anche dopo la chiusura del browser.
				await setPersistence(window.auth, browserLocalPersistence);
                window.appId = appId; // Store appId globally

                // Autenticazione
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Listener per l'autenticazione
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id').textContent = `ID Utente: ${user.uid}`;
                        
                        // 1. Carica il Profilo in modo sicuro
                        loadUserProfile().then(() => {
                            // 2. Esegui il rendering INIZIALE con i dati caricati/di default
                            renderDay(window.activeDay);
                            
                            // 3. Se autenticato E persistenza attiva, avvia l'ascolto in background.
                            if (window.userId && window.isPersistenceEnabled) {
                                 startDataListener(window.activeDay); 
                            }
                        }).catch(err => {
                             // Fallback se loadUserProfile fallisce, forziamo il rendering
                             console.error("Errore fatale nel caricamento utente, forzo il rendering:", err);
                             renderDay(window.activeDay);
                        });

                    } else {
                        document.getElementById('status-message').textContent = 'Non autenticato. Dati locali.';
                        window.userId = null;
                        renderUserProfileTitle();
                        renderDay(window.activeDay); // Aggiunto fallback rendering
                    }
                });

            } catch (error) {
                console.error("Errore durante l'inizializzazione di Firebase:", error);
                document.getElementById('status-message').textContent = 'Errore grave nell\'inizializzazione di Firebase. Persistenza disabilitata.';
                window.isPersistenceEnabled = false;
                
                // Assicura il rendering in caso di errore critico
                await loadUserProfile(); 
                renderDay(window.activeDay);
            }
        }

        // --- GESTIONE DATI FIRESTORE (Omesso per brevitÃ , codice invariato) ---
        // (codice di startDataListener, saveWeight, saveNote, ecc. qui)
        
        // --- FUNZIONI DI UTILITY & RENDERING (Omesso per brevitÃ , codice invariato) ---
        // (codice di nextStep, renderGuidedMode, renderDay, ecc. qui)
        
        // ... (resto delle funzioni)

        // --- RESTO DELLE FUNZIONI (necessarie per completezza ma omesse per brevitÃ ) ---
        function startDataListener(dayId) { /* ... codice invariato ... */ 
            if (!window.db || !window.userId || !window.isPersistenceEnabled) return;
            if (window.unsubscribeListener) { window.unsubscribeListener(); }
            const docRef = getLogDocumentRef(dayId);
            if (!docRef) return;
            window.unsubscribeListener = onSnapshot(docRef, (docSnap) => {
                const currentDay = window.workoutDays[dayId];
                if (!currentDay) return;
                if (docSnap.exists()) {
                    const loggedData = docSnap.data();
                    if (loggedData.exercises) {
                        currentDay.exercises = currentDay.exercises.map((exercise, exIndex) => {
                            const loggedExercise = loggedData.exercises[exIndex];
                            return {
                                ...exercise,
                                logged_weights: loggedExercise && loggedExercise.logged_weights ? loggedExercise.logged_weights : {},
                                logged_notes: loggedExercise && loggedExercise.logged_notes ? loggedExercise.logged_notes : "", 
                            };
                        });
                    }
                } else {
                    currentDay.exercises = currentDay.exercises.map(exercise => ({ ...exercise, logged_weights: {}, logged_notes: "", }));
                }
                if (window.isGuidedMode) {
                    renderGuidedMode();
                } else {
                    renderDay(dayId);
                    calculateTotalTonnageForDay(dayId);
                    updateTonnageDisplay();
                }
            }, (error) => {
                console.error("Errore onSnapshot:", error);
                document.getElementById('status-message').textContent = 'Errore nel caricamento dei dati in tempo reale.';
            });
        }
        
        async function saveWeight(dayId, exIndex, setIndex, weight) { /* ... codice invariato ... */
            if (!window.isPersistenceEnabled) { showTemporaryMessage('ATTENZIONE: La persistenza Ã¨ disabilitata. I dati non saranno salvati.', 'bg-red-500'); return; }
            const docRef = getLogDocumentRef(dayId);
            if (!docRef || !window.userId) { showTemporaryMessage('Errore: Utente non autenticato o DB non pronto.', 'bg-red-500'); return; }
            try {
                const currentDay = window.workoutDays[dayId];
                if (!currentDay) throw new Error("Giorno di allenamento non trovato.");
                const setKey = `set_${setIndex + 1}`;
                const weightValue = (weight === '' || weight === null) ? null : parseFloat(weight);
                currentDay.exercises[exIndex].logged_weights = currentDay.exercises[exIndex].logged_weights || {};
                currentDay.exercises[exIndex].logged_weights[setKey] = weightValue;
                if (!window.isGuidedMode) { calculateTotalTonnageForDay(dayId); updateTonnageDisplay(); }
                const dataToSave = {
                    dayId: dayId, dayName: currentDay.name,
                    exercises: currentDay.exercises.map(ex => ({
                        name: ex.name, sets: ex.sets, reps: ex.reps, rest: ex.rest, defaultWeight: ex.defaultWeight, imageUrl: ex.imageUrl,
                        logged_weights: ex.logged_weights || {}, logged_notes: ex.logged_notes || "" 
                    }))
                };
                await setDoc(docRef, dataToSave, { merge: false });
                showTemporaryMessage('Peso salvato con successo!', 'bg-green-600');
            } catch (error) { console.error("Errore nel salvataggio del peso:", error); showTemporaryMessage(`Errore di salvataggio: ${error.message}`, 'bg-red-500'); }
        }
        window.saveWeight = saveWeight;
        
        async function saveNote(dayId, exIndex, note) { /* ... codice invariato ... */ 
            if (!window.isPersistenceEnabled) { showTemporaryMessage('ATTENZIONE: La persistenza Ã¨ disabilitata. La nota non sarÃ  salvata.', 'bg-red-500'); return; }
            const docRef = getLogDocumentRef(dayId);
            if (!docRef || !window.userId) { showTemporaryMessage('Errore: Utente non autenticato o DB non pronto.', 'bg-red-500'); return; }
            try {
                const currentDay = window.workoutDays[dayId];
                if (!currentDay) throw new Error("Giorno di allenamento non trovato.");
                currentDay.exercises[exIndex].logged_notes = note;
                const dataToSave = {
                    dayId: dayId, dayName: currentDay.name,
                    exercises: currentDay.exercises.map(ex => ({
                        name: ex.name, sets: ex.sets, reps: ex.reps, rest: ex.rest, defaultWeight: ex.defaultWeight, imageUrl: ex.imageUrl,
                        logged_weights: ex.logged_weights || {}, logged_notes: ex.logged_notes || "" 
                    }))
                };
                await setDoc(docRef, dataToSave, { merge: false });
                showTemporaryMessage('Nota salvata con successo!', 'bg-green-600');
            } catch (error) { console.error("Errore nel salvataggio della nota:", error); showTemporaryMessage(`Errore di salvataggio nota: ${error.message}`, 'bg-red-500'); }
        }
        window.saveNote = saveNote;
        
        function showTemporaryMessage(message, colorClass) { /* ... codice invariato ... */
            const statusMessage = document.getElementById('status-message');
            const originalText = statusMessage.textContent;
            const originalClass = statusMessage.className;
            statusMessage.textContent = message;
            statusMessage.className = `text-sm font-medium text-white p-2 rounded ${colorClass}`;
            setTimeout(() => {
                if (statusMessage.textContent === message) {
                    statusMessage.textContent = originalText;
                    statusMessage.className = originalClass;
                }
            }, 3000);
        }

        async function generateExerciseTip(exerciseName, exerciseElement) { /* ... codice invariato ... */
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const button = document.getElementById(`tip-btn-${exerciseElement.id.replace('tip-output-', '')}`);
            if (button) button.disabled = true;
            exerciseElement.innerHTML = '<span class="text-yellow-400">Analisi in corso... âœ¨</span>';
            const systemPrompt = "Sei un personal trainer esperto e conciso. Fornisci un breve consiglio in italiano sulla corretta esecuzione dell'esercizio e indica i principali muscoli coinvolti, massimo 100 parole.";
            const userQuery = `Fornisci un consiglio per l'esercizio: ${exerciseName}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, tools: [{ "google_search": {} }] };
            try {
                let response; let attempt = 0; const MAX_ATTEMPTS = 3;
                while (attempt < MAX_ATTEMPTS) {
                    attempt++;
                    try {
                        response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (response.ok) break;
                        if (response.status === 429) { await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000)); continue; }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    } catch (e) {
                        if (attempt === MAX_ATTEMPTS) throw e;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Nessun consiglio generato.';
                let sourceHtml = ''; const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title, }))
                        .filter(source => source.uri && source.title);
                    if (sources.length > 0) {
                        sourceHtml = `<p class="text-xs text-gray-500 mt-2 italic border-t border-gray-700 pt-2">Fonte: <a href="${sources[0].uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition duration-150">${sources[0].title}</a></p>`;
                    }
                }
                exerciseElement.innerHTML = `<p class="text-sm text-gray-300 whitespace-pre-wrap">${text}</p>${sourceHtml}`;
            } catch (error) { console.error("Errore Gemini API:", error); exerciseElement.innerHTML = `Errore API: Impossibile generare il consiglio. Riprova piÃ¹ tardi.`; } finally { if (button) button.disabled = false; }
        }
        window.generateExerciseTip = generateExerciseTip;

        function getImageUrl(exercise) { /* ... codice invariato ... */ return exercise.imageUrl || `https://placehold.co/400x200/800080/ffffff/png?text=IMMAGINE+PER+${encodeURIComponent(exercise.name.toUpperCase().replace(/\s/g, '+'))}`; }
        function calculateTonnageForSet(repsString, weight) { /* ... codice invariato ... */
            const w = parseFloat(weight); if (isNaN(w) || w === null || w <= 0) { return 0; }
            let repsMatch = repsString.match(/(\d+)/); let reps = repsMatch ? parseInt(repsMatch[1], 10) : 1; 
            if (repsString.includes('-') && repsMatch) { const parts = repsString.split('-').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n)); if (parts.length === 2) { reps = Math.floor((parts[0] + parts[1]) / 2); } }
            return 1 * reps * w;
        }
        window.calculateTonnageForSet = calculateTonnageForSet;

        function calculateTotalTonnageForDay(dayId) { /* ... codice invariato ... */
            window.totalTonnage = 0; const currentDay = window.workoutDays[dayId]; if (!currentDay) return;
            currentDay.exercises.forEach(ex => {
                if (ex.logged_weights) {
                    for (const sKey in ex.logged_weights) { window.totalTonnage += calculateTonnageForSet(ex.reps, ex.logged_weights[sKey]); }
                }
            });
        }
        window.calculateTotalTonnageForDay = calculateTotalTonnageForDay;

        function updateTonnageDisplay() { /* ... codice invariato ... */
            const tonnageElement = document.getElementById('total-tonnage-display');
            if (tonnageElement) { tonnageElement.textContent = `Tonnellaggio: ${Math.round(window.totalTonnage).toLocaleString('it-IT')} kg`; tonnageElement.classList.remove('hidden'); }
        }
        window.updateTonnageDisplay = updateTonnageDisplay;

        function getRestTimeSeconds(restString) { /* ... codice invariato ... */
            const match = restString.match(/(\d+)/); return match ? parseInt(match[1], 10) : 0;
        }
        
        function updateTimerDisplay(timerId, seconds, isGuided = false) { /* ... codice invariato ... */
            const minutes = Math.floor(seconds / 60); const secs = seconds % 60; const display = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const displayElement = document.getElementById(timerId); if (!displayElement) return;
            displayElement.textContent = display;
            const button = document.getElementById(timerId.replace('timer-display', 'timer-button'));
            const terminateButton = document.getElementById(timerId.replace('timer-display', 'terminate-button'));
            const timerState = activeTimers[timerId];
            if (seconds > 0) {
                 displayElement.classList.remove('text-green-500', 'font-bold'); displayElement.classList.add('text-white');
                 if (seconds <= 5) { displayElement.classList.add('text-red-500'); } else { displayElement.classList.remove('text-red-500'); }
                 if (button) {
                     button.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-green-600', 'hover:bg-green-700', 'bg-red-600');
                     if (timerState && timerState.isRunning) {
                         button.textContent = `RIPOSO IN CORSO`; 
						 button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                         if (terminateButton) terminateButton.classList.remove('hidden');
                     } else {
                         button.textContent = 'Avvia Riposo'; 
						 button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                         if (terminateButton) terminateButton.classList.add('hidden');
                     }
                 }
            } else {
                displayElement.textContent = '00:00'; displayElement.classList.remove('text-white', 'text-red-500'); displayElement.classList.add('font-bold', 'text-green-500');
                if (terminateButton) terminateButton.classList.add('hidden');
                if (button) {
                     button.textContent = isGuided ? 'PROSSIMA SERIE/ESERCIZIO' : 'Avvia Riposo';
                     button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-blue-600', 'hover:bg-blue-700');
                     button.classList.add('bg-green-600', 'hover:bg-green-700');
                }
                if (isGuided && isRestPeriodActive) {
                    isRestPeriodActive = false; showTemporaryMessage('Riposo terminato! Pronto per il prossimo passo.', 'bg-green-600');
                    if ('vibrate' in navigator) { navigator.vibrate(500); }
                }
            }
        }
        let activeTimers = {}; let isRestPeriodActive = false;
        function startTimer(dayId, exIndex, restString, isGuided = false) { /* ... codice invariato ... */
            const timerId = `timer-display-${dayId}-${exIndex}`; const durationSeconds = getRestTimeSeconds(restString);
            if (durationSeconds <= 0) { if (isGuided) { nextStep(); } else { showTemporaryMessage(`Nessun tempo di riposo specificato per questo esercizio.`, 'bg-red-500'); } return; }
            if (activeTimers[timerId] && activeTimers[timerId].interval) { clearInterval(activeTimers[timerId].interval); }
            activeTimers[timerId] = { seconds: durationSeconds, isRunning: true, interval: null, }; isRestPeriodActive = true;
            const interval = setInterval(() => {
                if (activeTimers[timerId].isRunning) { activeTimers[timerId].seconds--; updateTimerDisplay(timerId, activeTimers[timerId].seconds, isGuided);
                    if (activeTimers[timerId].seconds <= 0) { clearInterval(interval); activeTimers[timerId].isRunning = false; activeTimers[timerId].interval = null; }
                }
            }, 1000);
            activeTimers[timerId].interval = interval; showTemporaryMessage(`Riposo di ${durationSeconds} secondi iniziato.`, 'bg-blue-600'); updateTimerDisplay(timerId, durationSeconds, isGuided);
        }
        function startTotalTimer() { /* ... codice invariato ... */
            if (window.totalTimerInterval) { clearInterval(window.totalTimerInterval); } window.totalTimeSeconds = 0;
            const timerElement = document.getElementById('total-timer');
            if (timerElement) { timerElement.classList.remove('hidden', 'font-extrabold', 'text-xl'); timerElement.classList.add('text-lg'); timerElement.textContent = 'Durata totale: 00:00:00'; }
            window.totalTimerInterval = setInterval(() => {
                window.totalTimeSeconds++;
                const hours = Math.floor(window.totalTimeSeconds / 3600); const minutes = Math.floor((window.totalTimeSeconds % 3600) / 60); const seconds = window.totalTimeSeconds % 60;
                const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timerElement) { timerElement.textContent = `Durata totale: ${display}`; }
            }, 1000);
        }
        function stopTotalTimer() { /* ... codice invariato ... */
            if (window.totalTimerInterval) { clearInterval(window.totalTimerInterval); window.totalTimerInterval = null; }
            const hours = Math.floor(window.totalTimeSeconds / 3600); const minutes = Math.floor((window.totalTimeSeconds % 3600) / 60); const seconds = window.totalTimeSeconds % 60; const finalTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const timerElement = document.getElementById('total-timer');
            if (timerElement) { timerElement.textContent = `Durata finale: ${finalTime}`; timerElement.classList.remove('text-lg'); timerElement.classList.add('font-extrabold', 'text-xl'); }
        }
		/**
		 * Stima le calorie bruciate per l'allenamento con i pesi, aggiustata al peso corporeo.
		 * @param {number} totalTonnage - Tonnellaggio totale in kg.
		 * @param {number} bodyWeight - Peso corporeo dell'utente in kg (da window.userProfile).
		 * @returns {number} Calorie stimate.
		 */
		function estimateWeightCalories(totalTonnage, bodyWeight) {
		    if (totalTonnage <= 0 || bodyWeight <= 0) return 0;
		    
		    // Fattore Base di Conversione Calorie per Tonnellata
		    // Usiamo 3.5 Calorie / tonnellata come punto di partenza.
		    const CAL_PER_TON_BASE = 3.5; 
		    const REFERENCE_WEIGHT = 70; // Peso di riferimento standard (70 kg)
		
		    // Aggiustamento: Il fattore viene scalato in base al peso dell'utente rispetto al peso di riferimento.
		    const adjustedFactor = CAL_PER_TON_BASE * (bodyWeight / REFERENCE_WEIGHT);
		    
		    const tonnageInTons = totalTonnage / 1000;
		    
		    // Calcolo: Tonnellate * Fattore Aggiustato
		    let estimatedCalories = tonnageInTons * adjustedFactor;
		    
		    // Arrotonda a 1 decimale
		    return Math.round(estimatedCalories * 10) / 10;
		}
		window.estimateWeightCalories = estimateWeightCalories;
        function terminateRest(dayId, exIndex) { /* ... codice invariato ... */
            const timerId = `timer-display-${dayId}-${exIndex}`; const timerState = activeTimers[timerId];
            if (timerState && timerState.interval) { clearInterval(timerState.interval); timerState.interval = null; timerState.isRunning = false; timerState.seconds = 0; isRestPeriodActive = false;
                showTemporaryMessage('Riposo terminato in anticipo. Avanti il prossimo passo!', 'bg-yellow-600'); updateTimerDisplay(timerId, 0, true); }
        }
        window.terminateRest = terminateRest;
        function toggleTimer(dayId, exIndex, restString, isGuided = false) { /* ... codice invariato ... */
            const timerId = `timer-display-${dayId}-${exIndex}`; const durationSeconds = getRestTimeSeconds(restString);
            if (durationSeconds <= 0) { if (isGuided) nextStep(); return; }
            const timerState = activeTimers[timerId];
            if (!timerState || !timerState.isRunning) {
                if (timerState && timerState.seconds <= 0 && isGuided) { nextStep(); } else { startTimer(dayId, exIndex, restString, isGuided); } return;
            }
        }
        window.toggleTimer = toggleTimer;
        function startGuidedMode() { /* ... codice invariato ... */
            window.isGuidedMode = true; window.currentExIndex = 0; window.currentSet = 1; window.totalTonnage = 0; window.exerciseTonnageMap = {}; 
			window.totalCalories = 0; // NUOVO: Reset Calorie Totali
			startTotalTimer();
            document.getElementById('day-tabs').classList.add('hidden'); document.getElementById('mode-toggle-button').classList.add('hidden');
            document.getElementById('guided-controls-container').classList.remove('hidden'); updateTonnageDisplay(); renderGuidedMode();
            showTemporaryMessage('ModalitÃ  Guidata avviata. Inizia il tuo allenamento!', 'bg-blue-600');
        }
        window.startGuidedMode = startGuidedMode;
		/**
		 * MODIFICATA: Interrompe l'allenamento e mostra la schermata di riepilogo/valutazione.
		 */
		function stopGuidedMode() {
		    // 1. Ferma il timer
		    stopTotalTimer(); 
		
		    // 2. Ottieni i dati
		    const dayData = window.workoutDays[window.activeDay];
		    const dayName = dayData ? dayData.name : "Allenamento";
		
		    // 3. Calcola le calorie parziali
		    const currentWeight = window.userProfile.weight > 0 ? window.userProfile.weight : 70;
		    window.totalCalories = estimateWeightCalories(window.totalTonnage, currentWeight);
		
		    // 4. Mostra la schermata di riepilogo e valutazione
		    // (Questo codice Ã¨ copiato da nextStep, ma con titolo diverso)
		    showTemporaryMessage(`Allenamento Interrotto in ${document.getElementById('total-timer').textContent.split(': ').pop()}`, 'bg-yellow-600');
		
		    document.getElementById('workout-content').innerHTML = 
		        `<div class="p-8 text-center bg-gray-700 rounded-xl shadow-2xl">` +
		            `<h2 class="text-4xl font-extrabold text-yellow-400 mb-4">âœ‹ ALLENAMENTO INTERROTTO</h2>` +
		            `<p class="text-xl text-gray-300">Hai terminato in anticipo. Salva i tuoi progressi parziali.</p>` +
		            `<p class="text-2xl font-extrabold text-green-400 mt-4">Volume Totale: ${Math.round(window.totalTonnage).toLocaleString('it-IT')} kg</p>` +
		            `<p class="text-2xl font-extrabold text-red-400 mt-2">ðŸ”¥ Calorie Stimate: ${window.totalCalories.toLocaleString('it-IT')} kcal</p>` +
		            `<p id="final-time-display" class="text-2xl font-extrabold text-white mt-4">${document.getElementById('total-timer').textContent}</p>` +
		
		            `<!-- Selettore Stelle -->` +
		            `<div class="mt-6">` +
		                `<p class="text-lg text-gray-300 mb-2">Come valuti questo allenamento?</p>` +
		                `<div class="flex justify-center items-center space-x-2 text-4xl cursor-pointer">` +
		                    `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(1)">&#9734;</span>` +
		                    `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(2)">&#9734;</span>` +
		                    `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(3)">&#9734;</span>` +
		                    `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(4)">&#9734;</span>` +
		                    `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(5)">&#9734;</span>` +
		                `</div>` +
		            `</div>` +
		
		            `<!-- Bottone Salva e Torna (chiama la funzione che ora funziona) -->` +
		            `<button onclick="window.saveAndExitGuidedMode('${dayName}')" class="mt-8 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition duration-150 shadow-lg">Salva e Torna</button>` +
		        `</div>`;
		
		    // 5. Pulisci la UI (ma non le variabili)
		    window.isGuidedMode = false;
		    isRestPeriodActive = false;
		    document.getElementById('guided-controls-container').classList.add('hidden');
		}
		window.stopGuidedMode = stopGuidedMode;
		/**
		 * NUOVA FUNZIONE INTERNA:
		 * Pulisce e resetta la UI alla fine della modalitÃ  guidata.
		 */
		function __internal_cleanup_guided_mode() {
		    // 5. Azzera tutte le variabili globali
		    window.isGuidedMode = false; 
		    window.currentExIndex = 0; 
		    window.currentSet = 1; 
		    window.totalTonnage = 0; 
		    window.exerciseTonnageMap = {}; 
		    isRestPeriodActive = false;
		    window.totalCalories = 0;
		    window.currentWorkoutRating = 0; // Resetta la valutazione
		
		    // 6. Ferma tutti i timer attivi
		    for (const timerId in activeTimers) { 
		        if (activeTimers[timerId] && activeTimers[timerId].interval) { 
		            clearInterval(activeTimers[timerId].interval); 
		        } 
		    } 
		    activeTimers = {};
		
		    // 7. Ripristina l'interfaccia
		    document.getElementById('day-tabs').classList.remove('hidden'); 
		    document.getElementById('mode-toggle-button').classList.remove('hidden');
		    document.getElementById('guided-controls-container').classList.add('hidden'); 
		
		    // 8. Renderizza la visualizzazione standard
		    renderDay(window.activeDay);
		}
		window.__internal_cleanup_guided_mode = __internal_cleanup_guided_mode;
		/**
		 * Disegna il grafico settimanale utilizzando Chart.js
		 */
		function renderWeeklyChart() {
			const canvasElement = document.getElementById('weeklyChart');
			if (!canvasElement) {
			    console.warn("Elemento Canvas 'weeklyChart' non trovato.");
			    return;
			}
			
			// --- NUOVO: Distrugge il grafico precedente se esiste ---
			const existingChart = Chart.getChart(canvasElement);
			if (existingChart) {
			    existingChart.destroy();
			}
			// --- FINE NUOVO CODICE ---
		    const dataDumpElement = document.getElementById('chart-data-dump');
		
		    if (!dataDumpElement || !canvasElement) return;
		
		    try {
		        const rawData = JSON.parse(dataDumpElement.value);
		        
		        // Filtra e prepara i dati per gli assi
		        const days = rawData.map(d => d.day);
		        const tonnageValues = rawData.map(d => d.totalTonnage);
		        const calorieValues = rawData.map(d => d.totalCalories);
		
		        // Se Chart.js Ã¨ caricato
		        if (typeof Chart !== 'undefined') {
		            new Chart(canvasElement, {
		                type: 'bar',
		                data: {
		                    labels: days,
		                    datasets: [
		                        {
		                            type: 'bar',
		                            label: 'Tonnellaggio (kg)',
		                            data: tonnageValues,
		                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // Blu
		                            borderColor: 'rgba(59, 130, 246, 1)',
		                            borderWidth: 1,
		                            yAxisID: 'y-tonnage',
		                            order: 2,
		                        },
		                        {
		                            type: 'line',
		                            label: 'Calorie (kcal)',
		                            data: calorieValues,
		                            borderColor: 'rgba(239, 68, 68, 1)', // Rosso
		                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
		                            fill: true,
		                            yAxisID: 'y-calories',
		                            order: 1,
		                            tension: 0.4
		                        }
		                    ]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false,
		                    scales: {
		                        x: {
		                            ticks: { color: 'white' },
		                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
		                        },
		                        'y-tonnage': {
		                            type: 'linear',
		                            position: 'left',
		                            title: { display: true, text: 'Tonnellaggio (kg)', color: 'white' },
		                            ticks: { color: 'white' },
		                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
		                            min: 0,
		                            suggestedMax: Math.max(...tonnageValues) * 1.2 || 1000 // Aumenta il massimo per leggibilitÃ 
		                        },
		                        'y-calories': {
		                            type: 'linear',
		                            position: 'right',
		                            title: { display: true, text: 'Calorie (kcal)', color: 'white' },
		                            ticks: { color: 'white' },
		                            grid: { drawOnChartArea: false }, // Disegna solo per l'asse Tonnellaggio
		                            min: 0,
									suggestedMax: Math.max(...calorieValues) > 0 ? Math.max(...calorieValues) * 1.2 : 100 // <-- AGGIUNGI QUESTO
		                        }
		                    },
		                    plugins: {
		                        legend: { labels: { color: 'white' } }
		                    }
		                }
		            });
		            // Nascondi l'elemento temporaneo di caricamento
		            document.getElementById('weekly-chart-container').classList.remove('min-h-[250px]');
		        } else {
		             console.error("Chart.js non Ã¨ definito. Assicurati che il CDN sia caricato correttamente.");
		        }
		
		    } catch (e) {
		        console.error("Errore durante il parsing o il rendering del grafico:", e);
		    }
		}
		async function logWorkoutHistory(dayName, rating) {
		    const historyColRef = getHistoryCollectionRef();
		    if (!historyColRef) return;
		
		    const timestamp = new Date();
		    
		    const workoutLog = {
		        date: timestamp.toISOString().split('T')[0], // Data (es. 2025-11-04)
		        startTime: new Date(timestamp.getTime() - window.totalTimeSeconds * 1000).toLocaleTimeString('it-IT'),
		        endTime: timestamp.toLocaleTimeString('it-IT'),
		        durationSeconds: window.totalTimeSeconds,
		        durationDisplay: `${Math.floor(window.totalTimeSeconds / 3600).toString().padStart(2, '0')}:${Math.floor((window.totalTimeSeconds % 3600) / 60).toString().padStart(2, '0')}:${(window.totalTimeSeconds % 60).toString().padStart(2, '0')}`,
		        dayName: dayName,
		        totalTonnage: Math.round(window.totalTonnage),
		        estimatedCalories: Math.round(window.totalCalories || 0),
				rating: rating || 0 
		    };
		
		    try {
		        // Usiamo addDoc per creare un nuovo documento con ID automatico
		        // await setDoc(doc(historyColRef), workoutLog); 
				await addDoc(historyColRef, workoutLog);
		        showTemporaryMessage('Allenamento salvato nello storico!', 'bg-green-600');
		    } catch (error) {
		        console.error("Errore nel log dello storico:", error);
		        showTemporaryMessage(`Errore nel salvataggio storico: ${error.message}`, 'bg-red-500');
		    }
		}
        window.stopGuidedMode = stopGuidedMode;
        function nextStep() { /* ... codice invariato ... */
            const dayData = window.workoutDays[window.activeDay]; const currentExercise = dayData.exercises[window.currentExIndex]; const setKey = `set_${window.currentSet}`;
            const isTimedExercise = currentExercise.sets === 0 || currentExercise.rest === "N/A" || !currentExercise.sets;
            if (!isTimedExercise) {
             	// --- INIZIO CORREZIONE TONNELLAGGIO ---
				let weightToCalculate = null;
				let weightNeedsSaving = false; // Flag per salvare il default
				
				// 1. Controlla se esiste un peso loggato (salvato da 'onchange')
				if (currentExercise.logged_weights && currentExercise.logged_weights[setKey] !== undefined && currentExercise.logged_weights[setKey] !== null) {
				    weightToCalculate = parseFloat(currentExercise.logged_weights[setKey]);
				} 
				// 2. Altrimenti, se l'utente non ha toccato l'input, usa il defaultWeight
				else if (currentExercise.defaultWeight && currentExercise.defaultWeight > 0) {
				    weightToCalculate = parseFloat(currentExercise.defaultWeight);
				    // Dobbiamo salvare questo default per coerenza
				    weightNeedsSaving = true; 
				}
				
				// Calcola il tonnellaggio solo se abbiamo un peso valido
				if (weightToCalculate !== null && weightToCalculate > 0) {
				    const tonnage = calculateTonnageForSet(currentExercise.reps, weightToCalculate); 
				    window.totalTonnage += tonnage; 
				    window.exerciseTonnageMap[window.currentExIndex] = (window.exerciseTonnageMap[window.currentExIndex] || 0) + tonnage; 
				    updateTonnageDisplay();
				
				    // Se stiamo usando il peso di default, salviamolo ora in background
				    if (weightNeedsSaving && window.isPersistenceEnabled) {
				        // Chiamiamo saveWeight in background (non c'Ã¨ bisogno di 'await')
				        // (dayId, exIndex, setIndex, weight)
				        window.saveWeight(window.activeDay, window.currentExIndex, window.currentSet - 1, weightToCalculate);
				    }
				} else { 
				    // Non mostrare un errore, l'utente potrebbe aver saltato la serie (peso 0 o nullo)
				    console.log(`Set ${window.currentSet} saltato (nessun peso) per ${currentExercise.name}. Tonnellaggio non aggiunto.`);
				}
				// --- FINE CORREZIONE TONNELLAGGIO ---   
			}
            const timerId = `timer-display-${window.activeDay}-${window.currentExIndex}`; if (activeTimers[timerId] && activeTimers[timerId].interval) { clearInterval(activeTimers[timerId].interval); } activeTimers[timerId] = null;
            if (!isTimedExercise && window.currentSet < currentExercise.sets) {
                window.currentSet++; showTemporaryMessage(`Prossima serie: ${window.currentSet} di ${currentExercise.sets}. Inizia la tua serie.`, 'bg-blue-600'); renderGuidedMode(); return;
            }
            const nextExIndex = window.currentExIndex + 1;
            if (nextExIndex < dayData.exercises.length) {
                window.currentExIndex = nextExIndex; window.currentSet = 1; showTemporaryMessage(`Esercizio successivo: ${dayData.exercises[nextExIndex].name}.`, 'bg-green-600'); renderGuidedMode(); return;
            }
            stopTotalTimer(); 
			// NUOVO: Calcola le calorie stimate totali con aggiustamento peso
			// Utilizza window.userProfile.weight, con fallback a 70 kg se non definito
			const currentWeight = window.userProfile.weight > 0 ? window.userProfile.weight : 50;
			window.totalCalories = estimateWeightCalories(window.totalTonnage, currentWeight);
			// *** NUOVA CHIAMATA PER LOGGARE L'ALLENAMENTO ***
			//logWorkoutHistory(dayData.name); 
			// ***********************************************
			showTemporaryMessage(`Allenamento terminato in ${document.getElementById('total-timer').textContent.split(': ').pop()}!`, 'bg-purple-600');
            document.getElementById('workout-content').innerHTML = `<div class="p-8 text-center bg-gray-700 rounded-xl shadow-2xl"><h2 class="text-4xl font-extrabold text-green-400 mb-4">ðŸ† ALLENAMENTO COMPLETATO! ðŸ¥³</h2>
			<p class="text-xl text-gray-300">Complimenti! Hai completato tutti gli esercizi per ${dayData.name}.</p>
			<p class="text-2xl font-extrabold text-yellow-400 mt-4">Volume Totale: ${Math.round(window.totalTonnage).toLocaleString('it-IT')} kg</p>
			<p class="text-2xl font-extrabold text-red-400 mt-2">ðŸ”¥ Calorie Stimate: ${window.totalCalories.toLocaleString('it-IT')} kcal</p>
			// ...
			<p id="final-time-display" class="text-2xl font-extrabold text-white mt-4">${document.getElementById('total-timer').textContent}</p>` +
			
			`<!-- NUOVO: Selettore Stelle -->` +
			`<div class="mt-6">` +
			    `<p class="text-lg text-gray-300 mb-2">Come valuti questo allenamento?</p>` +
			    `<div class="flex justify-center items-center space-x-2 text-4xl cursor-pointer">` +
			        `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(1)">&#9734;</span>` +
			        `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(2)">&#9734;</span>` +
			        `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(3)">&#9734;</span>` +
			        `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(4)">&#9734;</span>` +
			        `<span class="rating-star text-gray-600 hover:text-yellow-500 transition-colors" onclick="window.setRating(5)">&#9734;</span>` +
			    `</div>` +
			`</div>` +
			
			`<!-- MODIFICATO: Bottone Salva e Torna -->` +
			`<button onclick="window.saveAndExitGuidedMode('${dayData.name}')" class="mt-8 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition duration-150 shadow-lg">Salva e Torna</button>` +
			`</div>`;
            window.isGuidedMode = false; window.currentExIndex = 0; window.currentSet = 1; isRestPeriodActive = false; document.getElementById('guided-controls-container').classList.add('hidden');
        }
        window.nextStep = nextStep;
		/**
		 * Salva lo storico (con la valutazione) e esce dalla modalitÃ  guidata.
		 */
		async function saveAndExitGuidedMode(dayName) {
		    // 1. Salva i dati, passando la valutazione
		    await logWorkoutHistory(dayName, window.currentWorkoutRating);
		    
		    // 2. Resetta la valutazione per il prossimo allenamento
		    window.currentWorkoutRating = 0;
		    
		    // 3. Chiudi la modalitÃ  guidata
		    window.__internal_cleanup_guided_mode();
		}
		window.saveAndExitGuidedMode = saveAndExitGuidedMode;
		
        function renderGuidedMode() { /* ... codice invariato ... */
            const dayData = window.workoutDays[window.activeDay]; const contentDiv = document.getElementById('workout-content');
            if (window.currentExIndex >= dayData.exercises.length) { nextStep(); return; }
            const exercise = dayData.exercises[window.currentExIndex]; const exIndex = window.currentExIndex; const restSeconds = getRestTimeSeconds(exercise.rest); const timerId = `timer-display-${window.activeDay}-${exIndex}`;
            const isTimedExercise = exercise.sets === 0 || exercise.rest === "N/A" || !exercise.sets; if (isTimedExercise) { window.currentSet = 1; }
            const setKey = `set_${window.currentSet}`;
            const currentWeight = (exercise.logged_weights && exercise.logged_weights[setKey] !== undefined && exercise.logged_weights[setKey] !== null) ? exercise.logged_weights[setKey] : exercise.defaultWeight || '';
            const currentExTonnage = Math.round(window.exerciseTonnageMap[exIndex] || 0);
            const isTimerRunning = activeTimers[timerId] && activeTimers[timerId].isRunning && activeTimers[timerId].seconds > 0;
            const nextStepAction = (isTimerRunning || isTimedExercise) ? 'window.nextStep()' : `window.toggleTimer('${window.activeDay}', ${exIndex}, '${exercise.rest}', true)`;
            let html = `<div class="bg-gray-800 p-6 mb-6 rounded-xl shadow-2xl border-4 border-blue-500/50"><div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3"><h3 class="text-3xl font-extrabold text-white">${exercise.name}</h3>${!isTimedExercise ? `<span class="text-4xl font-mono font-bold text-yellow-400 p-2 bg-gray-700 rounded-lg">${window.currentSet}/${exercise.sets}</span>` : ''}</div><div class="flex flex-col md:flex-row gap-6"><div class="flex-shrink-0 w-full md:w-1/2"><img src="${getImageUrl(exercise)}" alt="Immagine di ${exercise.name}" onerror="this.onerror=null; this.src='https://placehold.co/400x200/800080/ffffff/png?text=IMMAGINE+NON+DISPONIBILE';" class="w-full h-auto object-cover rounded-lg border border-gray-600 shadow-md aspect-[4/3]">${!isTimedExercise ? `<div class="mt-4 p-4 bg-gray-900 rounded-xl"><label for="${window.activeDay}-${exIndex}-${window.currentSet - 1}" class="text-sm font-semibold mb-2 block text-yellow-300">Peso per Serie ${window.currentSet} (Reps: ${exercise.reps})</label><input type="number" step="0.5" value="${currentWeight}" onchange="window.saveWeight('${window.activeDay}', ${exIndex}, ${window.currentSet - 1}, this.value)" id="${window.activeDay}-${exIndex}-${window.currentSet - 1}" class="w-full p-3 text-2xl text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-center" placeholder="Peso (kg)"><p class="text-sm text-gray-400 mt-2 text-center">Tonnellaggio attuale esercizio: <span class="text-green-400 font-bold">${currentExTonnage.toLocaleString('it-IT')} kg</span></p></div>` : `<div class="mt-4 p-4 bg-gray-700 rounded-xl text-center"><p class="text-lg font-bold text-green-400">DURATA: ${exercise.reps}</p><button onclick="window.nextStep()" class="mt-4 px-4 py-2 bg-green-600 text-white font-semibold rounded-full hover:bg-green-700 transition duration-150 shadow-lg">COMPLETATO (Passa al Prossimo)</button></div>`}</div><div class="flex-grow flex flex-col justify-start"><p class="text-base text-gray-300 mb-4">${isTimedExercise ? `Concentrati sul mantenimento del ritmo o dell'intensitÃ  per la durata di ${exercise.reps}.` : `Esegui la tua ${window.currentSet}a serie. Concentrati sulla forma per ${exercise.reps} ripetizioni.`}</p><div class="mb-6"><button id="tip-btn-${window.activeDay}-${exIndex}" onclick="generateExerciseTip('${exercise.name}', document.getElementById('tip-output-${window.activeDay}-${exIndex}'))" class="w-full px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">âœ¨ Consiglio Esecuzione (AI)</button><div id="tip-output-${window.activeDay}-${exIndex}" class="p-3 mt-2 bg-gray-900 rounded-lg text-gray-400 min-h-[50px] flex items-center"><span class="text-xs">${exercise.notes ? `Nota Predefinita: ${exercise.notes}` : 'Clicca per un consiglio sul corretto svolgimento.'}</span></div></div>${!isTimedExercise ? `<p class="text-sm text-gray-400 mt-auto">Recupero Previsto: <span class="text-yellow-300 font-semibold">${exercise.rest}</span></p><div class="mt-2 flex items-center gap-3"><button id="timer-button-${window.activeDay}-${exIndex}" onclick="window.toggleTimer('${window.activeDay}', ${exIndex}, '${exercise.rest}', true)" class="px-4 py-3 bg-indigo-600 text-white font-bold rounded-full hover:bg-indigo-700 transition duration-150 shadow-lg flex-grow disabled:opacity-50">Avvia Riposo</button><span id="${timerId}" class="text-4xl font-mono tracking-wider text-white flex-shrink-0 min-w-[90px] text-right">${String(Math.floor(restSeconds / 60)).padStart(2, '0')}:${String(restSeconds % 60).padStart(2, '0')}</span></div><button id="terminate-button-${window.activeDay}-${exIndex}" onclick="window.terminateRest('${window.activeDay}', ${exIndex})" class="hidden mt-2 px-4 py-2 bg-red-700 text-white font-semibold rounded-full hover:bg-red-800 transition duration-150 shadow-md">Termina in Anticipo</button>` : ''}</div></div><div class="mt-6 border-t border-gray-700 pt-4"><label for="notes-guided-${exIndex}" class="font-bold mb-2 block text-sm text-white">Note Personali per l'Esercizio:</label><textarea id="notes-guided-${exIndex}" rows="1" placeholder="${exercise.notes || 'Aggiungi note personali su esecuzione, sensazioni... (Es. presa stretta, cedimento)'}" onchange="window.saveNote('${window.activeDay}', ${exIndex}, this.value)" class="w-full p-3 text-sm text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner">${(exercise.logged_notes && exercise.logged_notes.trim()) ? exercise.logged_notes : ''}</textarea></div></div>`;
            contentDiv.innerHTML = html;
            if (!isTimedExercise) { updateTimerDisplay(timerId, activeTimers[timerId] ? activeTimers[timerId].seconds : restSeconds, true); }
        }
        function switchDay(newDayId) { /* ... codice invariato ... */
            if (window.isGuidedMode) { stopGuidedMode(); }
            if (window.activeDay === newDayId) return; window.activeDay = newDayId;
            calculateTotalTonnageForDay(newDayId); updateTonnageDisplay();
            renderDay(newDayId);
            if (window.isPersistenceEnabled) { startDataListener(newDayId); }
            document.querySelectorAll('.day-tab').forEach(tab => {
                if (tab.dataset.day === newDayId) { tab.classList.remove('text-gray-400', 'border-transparent'); tab.classList.add('text-white', 'border-blue-500', 'bg-gray-800'); } else { tab.classList.remove('text-white', 'border-blue-500', 'bg-gray-800'); tab.classList.add('text-gray-400', 'border-transparent'); }
            });
        }
        window.switchDay = switchDay;
		function renderDay(dayId) { /* ... codice invariato ... */
			const dayData = window.workoutDays[dayId]; const contentDiv = document.getElementById('workout-content');
			document.getElementById('mode-toggle-button').classList.remove('hidden'); document.getElementById('guided-controls-container').classList.add('hidden'); document.getElementById('day-tabs').classList.remove('hidden'); document.getElementById('total-timer').classList.add('hidden');
			if (!dayData) { contentDiv.innerHTML = '<p class="text-red-500">Giorno di allenamento non trovato.</p>'; return; }
			let html = `<h2 class="text-3xl font-bold mb-6 text-blue-400">${dayData.name}</h2>`;
			dayData.exercises.forEach((exercise, exIndex) => {
				const restSeconds = getRestTimeSeconds(exercise.rest); const timerId = `timer-display-${dayId}-${exIndex}`; const isTimedExercise = exercise.sets === 0 || exercise.rest === "N/A" || !exercise.sets;
				html += `<div class="bg-gray-800 p-4 mb-6 rounded-xl shadow-lg border border-gray-700 transform transition-transform duration-300 hover:scale-[1.005]"><div class="flex flex-col md:flex-row gap-4"><div class="flex-shrink-0 w-full md:w-1/3"><img src="${getImageUrl(exercise)}" alt="Immagine di ${exercise.name}" onerror="this.onerror=null; this.src='https://placehold.co/400x200/800080/ffffff/png?text=LINK+NON+PUBBLICO!+Carica+un+link+diretto';" class="w-full h-auto object-cover rounded-lg border border-gray-600 shadow-md aspect-[4/3]"></div><div class="flex-grow flex flex-col justify-between"><div><h3 class="text-2xl font-bold mb-1 text-white">${exercise.name}</h3><p class="text-sm text-gray-400">Ripetizioni/Durata: <span class="text-blue-300 font-semibold">${exercise.reps}</span></p></div>${!isTimedExercise ? `<div class="mt-4"><p class="text-sm text-gray-400">Recupero Previsto: <span class="text-yellow-300 font-semibold">${exercise.rest}</span></p></div>` : `<p class="text-sm text-gray-400 mt-2 p-3 bg-gray-700 rounded-lg">ModalitÃ : <span class="text-green-400 font-bold">Continuo / Durata (Non a Serie)</span></p>`}</div></div><div class="mt-6 border-t border-gray-700 pt-4"><p class="font-medium mb-2 text-gray-300">Consiglio del Personal Trainer AI:</p><div class="flex flex-col gap-3"><button id="tip-btn-${dayId}-${exIndex}" onclick="generateExerciseTip('${exercise.name}', document.getElementById('tip-output-${dayId}-${exIndex}'))" class="w-full px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">âœ¨ Chiedi un Tip sull'Esecuzione</button><div id="tip-output-${dayId}-${exIndex}" class="p-3 bg-gray-900 rounded-lg flex-grow text-gray-400 w-full min-h-[50px] flex items-center"><span class="text-xs">${exercise.notes ? `Nota Predefinita: ${exercise.notes}` : 'Clicca per un consiglio sul corretto svolgimento.'}</span></div></div></div>${!isTimedExercise ? `<div class="mt-6 border-t border-gray-700 pt-4">` : ''}`;
				if (!isTimedExercise) {
					const prevSetWeight = (exercise.logged_weights && exercise.logged_weights['set_1'] !== undefined && exercise.logged_weights['set_1'] !== null) ? exercise.logged_weights['set_1'] : exercise.defaultWeight || 'N/A';
					html += `<p class="text-sm font-semibold mb-3 text-gray-400">Peso Ultima Serie Loggata (Set 1): <span class="text-indigo-400 font-extrabold">${prevSetWeight} kg</span></p><p class="font-bold mb-3 text-lg text-yellow-400">Log Pesi (in kg):</p><div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">`;
					for (let setIndex = 0; setIndex < exercise.sets; setIndex++) {
						const setKey = `set_${setIndex + 1}`; const currentWeight = (exercise.logged_weights && exercise.logged_weights[setKey] !== undefined && exercise.logged_weights[setKey] !== null) ? exercise.logged_weights[setKey] : exercise.defaultWeight || '';
						html += `<div class="flex flex-col relative"><label for="${dayId}-${exIndex}-${setIndex}" class="text-xs font-semibold mb-1 text-gray-400">Serie ${setIndex + 1} (${exercise.reps})</label><input type="number" step="0.5" value="${currentWeight}" onchange="window.saveWeight('${dayId}', ${exIndex}, ${setIndex}, this.value)" id="${dayId}-${exIndex}-${setIndex}" class="w-full p-3 text-lg text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner" placeholder="Peso (kg)"></div>`;
					}
				}
				html += `${!isTimedExercise ? `</div></div>` : ''}<div class="mt-6 border-t border-gray-700 pt-4"><label for="notes-${dayId}-${exIndex}" class="font-bold mb-2 block text-sm text-white">Note Personali:</label><textarea id="notes-${dayId}-${exIndex}" rows="1" placeholder="${exercise.notes || 'Aggiungi note personali su esecuzione, sensazioni, o modifiche... (Es. presa stretta, cedimento alla 8a rip.)'}" onchange="window.saveNote('${dayId}', ${exIndex}, this.value)" class="w-full p-3 text-sm text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner">${(exercise.logged_notes && exercise.logged_notes.trim()) ? exercise.logged_notes : ''}</textarea></div></div>`;
			});
			contentDiv.innerHTML = html;
		}

        document.addEventListener('DOMContentLoaded', () => {
            const tabsContainer = document.getElementById('day-tabs');
            let tabsHtml = '';
            let isFirst = true;
            for (const [dayId, data] of Object.entries(window.workoutDays)) {
                const activeClasses = isFirst ? 'text-white border-blue-500 bg-gray-800' : 'text-gray-400 border-transparent';
                tabsHtml += `<button class="day-tab flex-1 py-3 text-base font-semibold border-b-2 ${activeClasses} transition duration-300 hover:border-blue-500 hover:text-white hover:bg-gray-800/70" data-day="${dayId}" onclick="window.switchDay('${dayId}')">${data.name.split(':')[0]}</button>`;
                isFirst = false;
            }
            tabsContainer.innerHTML = tabsHtml;
			// --- NUOVA AGGIUNTA: REGISTRAZIONE SERVICE WORKER ---
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.register('sw.js')
					.then(registration => {
						console.log('Service Worker registrato con successo:', registration);
					})
					.catch(error => {
						console.error('Registrazione Service Worker fallita:', error);
					});
			}
			// --- FINE AGGIUNTA ---
            initializeFirebase();
        });
    </script>
</head>
<body class="min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
		<header class="text-center mb-8 border-b border-gray-700 pb-4 relative">
            <button onclick="openMenu()" class="absolute top-2 right-0 p-2 rounded-full hover:bg-gray-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 z-30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <h1 id="main-title" class="text-4xl font-extrabold text-blue-500 tracking-tight">
                ðŸ’ª Piano di allenamento Laura Corridoni
            </h1>
        </header>
        <div class="mb-6 p-3 bg-gray-900 rounded-xl border border-gray-700 text-center">
            <p id="status-message" class="text-sm font-medium text-green-400">Inizializzazione in corso...</p>
            <p id="user-id" class="text-xs text-gray-500 mt-1 hidden"></p>
        </div>
        <div id="day-tabs" class="flex justify-around bg-gray-900 rounded-t-xl overflow-hidden border-b-2 border-gray-700 mb-4">
            </div>

        <div class="text-center mb-6">
            <button id="mode-toggle-button" onclick="window.startGuidedMode()" 
                    class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-150 disabled:opacity-50">
                ðŸš€ Avvia Allenamento
            </button>
            
            <div id="guided-controls-container" class="hidden mt-4 flex flex-col items-center gap-2">
                 <button id="stop-guided-button" onclick="window.stopGuidedMode()" 
                        class="px-6 py-3 bg-yellow-600 text-white font-bold rounded-full shadow-lg hover:bg-yellow-700 transition duration-150">
                    ðŸ›‘ Termina Allenamento
                </button>
                <p id="total-tonnage-display" class="mt-2 text-lg font-mono text-green-400 font-bold hidden">Tonnellaggio: 0 kg</p> 
                <p id="total-timer" class="mt-3 text-lg font-mono text-white/80">Durata totale: 00:00:00</p>
            </div>
        </div>

        <div id="workout-content" class="min-h-[500px] p-2">
            <p class="text-center text-gray-500 pt-20">Caricamento del programma...</p>
        </div>

    </div>
    
    <div id="profile-modal" class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-80 flex items-center justify-center hidden" 
         onclick="if(event.target.id === 'profile-modal') closeProfileModal()">
        
        <div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md mx-4 border border-gray-700">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h2 class="text-2xl font-bold text-pink-400">ðŸ‘¤ Informazioni Personali</h2>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-white transition duration-150 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="personal-info-content">
                <p class="text-sm text-gray-500">Caricamento...</p>
            </div>

            <div class="mt-6 text-center">
                <button onclick="closeProfileModal()" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition duration-150">
                    Chiudi
                </button>
            </div>
        </div>
    </div>

	<div id="history-modal" class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-80 flex items-center justify-center hidden" 
         onclick="if(event.target.id === 'history-modal') closeHistoryModal()">
        
        <div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-2xl mx-4 border border-gray-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4 sticky top-0 bg-gray-800 z-10">
                <h2 class="text-2xl font-bold text-yellow-400">ðŸ“œ Storico Allenamenti</h2>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-white transition duration-150 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="history-content" class="space-y-4">
                <p class="text-center text-gray-500">Caricamento storico...</p>
            </div>

        </div>
    </div>
	<div id="off-canvas-menu" class="fixed inset-0 z-40 hidden" onclick="if(event.target.id === 'off-canvas-menu') closeMenu()">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-80"></div> 
        
        <div class="off-canvas active absolute top-0 right-0 w-64 h-full bg-gray-800 shadow-2xl p-6 border-l border-gray-700 flex flex-col">
            
            <h3 class="text-2xl font-bold text-blue-400 mb-6 border-b border-gray-700 pb-3">Menu</h3>
            
            <div class="space-y-4">
                <button onclick="openProfileModal()" class="w-full text-left p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-pink-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    Profilo Utente
                </button>

                <button onclick="openHistoryModal()" class="w-full text-left p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c1.657 0 3 1.343 3 3v2h2v-2c0-2.761-2.239-5-5-5s-5 2.239-5 5v2h2v-2c0-1.657 1.343-3 3-3zM2 20h20M4 17h16" /></svg>
                    Storico Allenamenti
                </button>
                
                </div>
            
            <button onclick="closeMenu()" class="mt-auto px-4 py-2 bg-red-600 text-white font-semibold rounded-full hover:bg-red-700 transition duration-150">
                Chiudi Menu
            </button>
        </div>
    </div>
</body>
</html>
</body>
</html>
