<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano di allenamento per Laura Corridoni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile di base e font Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #ffffff;
        }
        /* Stile per l'input focalizzato */
        input:focus {
            --tw-ring-color: #3b82f6;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importa getDoc per caricare il profilo una tantum
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabili Globali
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.activeDay = 'day_1'; // Giorno attivo di default
        window.isPersistenceEnabled = false; // Flag per tracciare la persistenza
        
        // Nuove variabili per la Modalità Guidata
        window.isGuidedMode = false;
        window.currentExIndex = 0; // Indice dell'esercizio corrente (0-based)
        window.currentSet = 1;      // Numero della serie corrente (1-based)
        window.unsubscribeListener = null; // Per pulire il listener Firestore

		// Variabili per Cronometro Totale e Tonnellaggio
        window.totalTimeSeconds = 0;
        window.totalTimerInterval = null;
        window.totalTonnage = 0; 
        window.exerciseTonnageMap = {}; 

        // NUOVA VARIABILE: Profilo Utente
        window.userProfile = {
            name: 'Laura Corridoni',
            weight: 60, // Peso di default (kg)
            age: 30,    // Età di default
        };

        // Struttura degli allenamenti (DATI MOCK AGGIORNATI CON NOTE DI DEFAULT)
        window.workoutDays = {
            'day_1': {
                name: "Giorno 1: Petto e Tricipiti",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO', notes: "Mantieni un ritmo moderato che ti consenta di parlare." },
                    { name: "Chest Press distensioni delle braccia", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 20, imageUrl: './images/chestpress.png?text=CHEST+PRESS', notes: "Spingi i gomiti in avanti. Contrai il petto al massimo accorciamento." },
                    { name: "Pectoral Machine Adduzioni delle braccia", sets: 3, reps: "10-12", rest: "90s", defaultWeight: 20, imageUrl: './images/pectoral.png?text=PECTORAL+FLY', notes: "Mantieni le spalle basse e concentratevi solo sulla contrazione del petto." },
                    { name: "French Press (Manubri)", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 6, imageUrl: './images/french-press.png?text=PECTORAL+FLY?text=FRENCH+PRESS', notes: "Movimento controllato, senti l'allungamento. Usa un peso moderato." },
                    { name: "Spinte in Basso (Pushdown)", sets: 3, reps: "10-15", rest: "60s", defaultWeight: 10, imageUrl: './images/pushdown.png?text=TRICIPITI+PUSH', notes: "Porta il cavo fino in fondo. Contrai il tricipite alla massima estensione." },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI', notes: "Esegui lentamente con controllo. Non forzare l'estensione." },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH', notes: "Concentrati sull'avvicinare lo sterno al bacino, non sul collo." },
                ]
            },
            'day_2': {
                name: "Giorno 2: Schiena e Bicipiti",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO', notes: "Mantieni un ritmo moderato che ti consenta di parlare." },
                    { name: "Lat Machine", sets: 4, reps: "8-10", rest: "90s", defaultWeight: 50, imageUrl: './images/lat-machine.png?text=LAT+MACHINE', notes: "Tira con i gomiti, non con i bicipiti. Schiena dritta." },
                    { name: "Pulley basso con Triangolo", sets: 3, reps: "10-12 (per braccio)", rest: "60s", defaultWeight: 20, imageUrl: './images/pulley-basso.png?text=REMATORE', notes: "Petto in fuori, schiena inarcata. Porta il triangolo all'ombelico." },
                    { name: "Curl seduto con Manubri", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 25, imageUrl: './images/curl-manubri-seduto-bg.png?text=CURL+BILANCIERE', notes: "Ruota il polso (supinazione) durante la salita. Non oscillare." },
                    { name: "Curl a Martello ai Cavi", sets: 3, reps: "10-15", rest: "60s", defaultWeight: 10, imageUrl: './images/hammer-curl.png?text=CURL+HAMMER', notes: "Focus sull'avambraccio. Presa neutra e stretta." },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI', notes: "Esegui lentamente con controllo. Non forzare l'estensione." },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH', notes: "Concentrati sull'avvicinare lo sterno al bacino, non sul collo." },
                ]
            },
            'day_3': {
                name: "Giorno 3: Gambe e Spalle",
                exercises: [
                    { name: "Cardio Stepper", sets: 0, reps: "10 min", rest: "N/A", defaultWeight: 0, imageUrl: './images/stepper.jpg?text=CARDIO', notes: "Mantieni un ritmo moderato che ti consenta di parlare." },
                    { name: "Leg Press", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/leg-press.png?text=LEG+PRESS', notes: "Non bloccare le ginocchia in alto. Spingi con i talloni." },
                    { name: "Leg Extension", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/legext.png?text=LEG+EXT', notes: "Contrai il quadricipite per un secondo al massimo accorciamento." },
                    { name: "Leg Curl Sdraiato", sets: 3, reps: "10-15", rest: "90s", defaultWeight: 120, imageUrl: './images/leg-curl-sdraiato-bg.png?text=LEG+CURL', notes: "Focus sui femorali. Movimento lento in fase negativa." },
                    { name: "Adduzioni", sets: 3, reps: "8-12", rest: "90s", defaultWeight: 15, imageUrl: './images/adductor.png?text=ADDUCTOR', notes: "Siediti in modo da isolare solo gli adduttori. Controlla il ritorno." },
                    { name: "Alzate Laterali", sets: 3, reps: "12", rest: "60s", defaultWeight: 8, imageUrl: './images/alzate-laterali.png?text=ALZATE+LATERALI', notes: "Gomiti leggermente flessi. Porta i manubri all'altezza delle spalle, non più su." },
                    { name: "Alzate Frontali", sets: 3, reps: "12", rest: "60s", defaultWeight: 8, imageUrl: './images/alzate-frontali.png?text=ALZATE+FRONTALI', notes: "Solleva alternando le braccia o entrambe insieme. Movimento controllato." },
                    { name: "Lombari Iperestensioni", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/lombari.jpg?text=LOMBARI', notes: "Esegui lentamente con controllo. Non forzare l'estensione." },
                    { name: "Abdoninal Crunch", sets: 3, reps: "15", rest: "60s", defaultWeight: 40, imageUrl: './images/crunch.jpg?text=CRUNCH', notes: "Concentrati sull'avvicinare lo sterno al bacino, non sul collo." },
                ]
            },
        };

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        // Configurazione Firebase: Per GitHub Pages, devi INSERIRE QUI LA TUA CONFIGURAZIONE.
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCfTXY1foD8Dr9UxRNzLeOu680aNtIw4TA",
            authDomain: "training-c0b76.firebaseapp.com",
            projectId: "training-c0b76",
            storageBucket: "training-c0b76.firebasestorage.app",
            messagingSenderId: "149618028951",
            appId: "1:149618028951:web:03756bdf1273a4521954d2"
        };
		
        async function initializeFirebase() {
            let firebaseConfig;
            let initialAuthToken = null;
            let appId = 'default-app-id';

            try {
                // 1. Tenta variabili Canvas (PRIORITÀ)
                const canvasConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const canvasToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : appId;
                
                if (Object.keys(canvasConfig).length > 0) {
                    firebaseConfig = canvasConfig;
                    initialAuthToken = canvasToken;
                    appId = canvasAppId;
                    window.isPersistenceEnabled = true;
                    document.getElementById('status-message').textContent = 'Connesso (Canvas Environment). La persistenza è attiva.';
                } else if (Object.keys(MANUAL_FIREBASE_CONFIG).length > 0) {
                    // 2. Usa la configurazione manuale (FALLBACK)
                    firebaseConfig = MANUAL_FIREBASE_CONFIG;
                    appId = firebaseConfig.projectId || 'manual-app-id';
                    window.isPersistenceEnabled = true;
                    document.getElementById('status-message').textContent = 'Connesso (Configurazione Manuale). La persistenza è attiva.';
                } else {
                    // 3. Nessuna configurazione trovata (Modalità Solo Visualizzazione)
                    window.isPersistenceEnabled = false;
                    document.getElementById('status-message').textContent = 'ATTENZIONE: Persistenza disabilitata. Dati NON saranno salvati.';
                    // Esegui il rendering senza attendere l'autenticazione
                    renderDay(window.activeDay);
                    renderUserProfile(); // Renderizza il profilo di default
                    return; 
                }
                
                // --- Inizializzazione Firebase (Solo se la configurazione è valida) ---
                setLogLevel('error'); // Mostra solo errori per pulizia console
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                window.appId = appId; // Store appId globally

                // Autenticazione (Utilizza token se disponibile, altrimenti anonima)
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Listener per l'autenticazione
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id').textContent = `ID Utente: ${user.uid}`;
                        console.log('Firebase Initialized and User Authenticated:', window.userId);

                        // Carica prima il profilo utente e poi i dati di allenamento
                        loadUserProfile().then(() => {
                            renderDay(window.activeDay);
                            startDataListener(window.activeDay);
                        });
                    } else {
                        console.log('No user signed in.');
                        document.getElementById('status-message').textContent = 'Non autenticato. Dati locali.';
                        window.userId = null;
                        renderUserProfile(); // Renderizza il profilo di default
                    }
                });

            } catch (error) {
                console.error("Errore durante l'inizializzazione di Firebase:", error);
                document.getElementById('status-message').textContent = 'Errore grave nell\'inizializzazione di Firebase. Persistenza disabilitata.';
                window.isPersistenceEnabled = false;
                renderDay(window.activeDay);
                renderUserProfile(); // Renderizza il profilo di default
            }
        }

        // --- GESTIONE DATI UTENTE E FIRESTORE ---

        function getLogDocumentRef(dayId) {
            if (!window.userId || !window.db || !window.isPersistenceEnabled) return null;
            // Percorso standard per dati privati in Canvas
            const appId = window.appId || 'default-app-id'; 
            const collectionPath = `artifacts/${appId}/users/${window.userId}/workout_logs`;
            return doc(window.db, collectionPath, dayId);
        }

        function getProfileDocumentRef() {
            if (!window.userId || !window.db || !window.isPersistenceEnabled) return null;
            const appId = window.appId || 'default-app-id'; 
            const collectionPath = `artifacts/${appId}/users/${window.userId}`;
            // Usa un documento chiamato 'profile' nella sottocollezione
            return doc(window.db, collectionPath, 'profile'); 
        }

        /**
         * Carica il profilo utente da Firestore.
         */
        async function loadUserProfile() {
            const docRef = getProfileDocumentRef();
            if (!docRef) {
                renderUserProfile();
                return;
            }

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const profileData = docSnap.data();
                    window.userProfile = {
                        name: profileData.name || window.userProfile.name,
                        weight: profileData.weight || window.userProfile.weight,
                        age: profileData.age || window.userProfile.age,
                    };
                    console.log('Profilo utente caricato:', window.userProfile);
                }
            } catch (error) {
                console.error("Errore nel caricamento del profilo utente:", error);
            } finally {
                renderUserProfile();
            }
        }
        
        /**
         * Salva e aggiorna i dati del profilo utente.
         */
        async function saveUserProfile(field, value) {
            if (!window.isPersistenceEnabled || !window.userId) {
                showTemporaryMessage('ATTENZIONE: Persistenza disabilitata. Dati NON salvati.', 'bg-red-500');
                return;
            }

            const docRef = getProfileDocumentRef();
            if (!docRef) return;

            // Aggiorna la variabile globale
            if (field === 'name') {
                window.userProfile.name = value;
            } else if (field === 'weight') {
                window.userProfile.weight = parseFloat(value) || window.userProfile.weight;
            } else if (field === 'age') {
                window.userProfile.age = parseInt(value) || window.userProfile.age;
            }

            try {
                await setDoc(docRef, window.userProfile, { merge: true });
                showTemporaryMessage(`Profilo aggiornato (${field} salvato)!`, 'bg-blue-600');
            } catch (error) {
                console.error("Errore nel salvataggio del profilo:", error);
                showTemporaryMessage(`Errore di salvataggio profilo: ${error.message}`, 'bg-red-500');
            }
        }
        window.saveUserProfile = saveUserProfile;

        /**
         * Renderizza la sezione del profilo utente.
         */
        function renderUserProfile() {
            const container = document.getElementById('personal-info-container');
            if (!container) return;

            // Aggiorna l'header con il nome
            document.getElementById('main-title').textContent = `💪 Piano di allenamento ${window.userProfile.name}`;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex flex-col">
                        <label for="profile-name" class="text-xs font-semibold mb-1 text-gray-400">Nome Utente</label>
                        <input type="text" id="profile-name" value="${window.userProfile.name}"
                                onchange="window.saveUserProfile('name', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="Il tuo nome">
                    </div>
                    <div class="flex flex-col">
                        <label for="profile-weight" class="text-xs font-semibold mb-1 text-gray-400">Peso (kg)</label>
                        <input type="number" step="0.1" id="profile-weight" value="${window.userProfile.weight}"
                                onchange="window.saveUserProfile('weight', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="00.0">
                    </div>
                    <div class="flex flex-col">
                        <label for="profile-age" class="text-xs font-semibold mb-1 text-gray-400">Età</label>
                        <input type="number" id="profile-age" value="${window.userProfile.age}"
                                onchange="window.saveUserProfile('age', this.value)"
                                class="w-full p-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="00">
                    </div>
                </div>
            `;
        }
        window.renderUserProfile = renderUserProfile;


        /**
         * Real-time listener per i dati del giorno attivo.
         */
        function startDataListener(dayId) {
            if (!window.db || !window.userId || !window.isPersistenceEnabled) return;

            // Cancella eventuali listener di giorni precedenti
            if (window.unsubscribeListener) {
                window.unsubscribeListener();
            }

            const docRef = getLogDocumentRef(dayId);
            if (!docRef) return;

            window.unsubscribeListener = onSnapshot(docRef, (docSnap) => {
                const currentDay = window.workoutDays[dayId];
                if (!currentDay) return;

                if (docSnap.exists()) {
                    const loggedData = docSnap.data();
                    console.log(`Dati per ${dayId} caricati da Firestore:`, loggedData);
                    
                    if (loggedData.exercises) {
                        currentDay.exercises = currentDay.exercises.map((exercise, exIndex) => {
                            const loggedExercise = loggedData.exercises[exIndex];
                            return {
                                ...exercise,
                                logged_weights: loggedExercise && loggedExercise.logged_weights ? loggedExercise.logged_weights : {},
                                logged_notes: loggedExercise && loggedExercise.logged_notes ? loggedExercise.logged_notes : "", 
                            };
                        });
                    }
                } else {
                    console.log(`Nessun log trovato per ${dayId}.`);
                    // Assicurati che le proprietà loggate siano inizializzate per evitare errori
                    currentDay.exercises = currentDay.exercises.map(exercise => ({
                        ...exercise,
                        logged_weights: {},
                        logged_notes: "", 
                    }));
                }
                
                // Chiama il rendering corretto in base alla modalità
                if (window.isGuidedMode) {
                    renderGuidedMode();
                } else {
                    renderDay(dayId);
                    // In modalità standard, calcoliamo il tonnellaggio totale qui
                    calculateTotalTonnageForDay(dayId);
                    updateTonnageDisplay();
                }

            }, (error) => {
                console.error("Errore onSnapshot:", error);
                document.getElementById('status-message').textContent = 'Errore nel caricamento dei dati in tempo reale.';
            });
        }

        /**
         * Salva una singola voce di peso su Firestore.
         */
        async function saveWeight(dayId, exIndex, setIndex, weight) {
            if (!window.isPersistenceEnabled) {
                 showTemporaryMessage('ATTENZIONE: La persistenza è disabilitata. I dati non saranno salvati.', 'bg-red-500');
                 return;
            }

            const docRef = getLogDocumentRef(dayId);
            if (!docRef || !window.userId) {
                showTemporaryMessage('Errore: Utente non autenticato o DB non pronto.', 'bg-red-500');
                return;
            }

            try {
                const currentDay = window.workoutDays[dayId];
                if (!currentDay) throw new Error("Giorno di allenamento non trovato.");

                // 1. Aggiorna lo stato in memoria
                const setKey = `set_${setIndex + 1}`;
                const weightValue = (weight === '' || weight === null) ? null : parseFloat(weight);

                currentDay.exercises[exIndex].logged_weights = currentDay.exercises[exIndex].logged_weights || {};
                currentDay.exercises[exIndex].logged_weights[setKey] = weightValue;
                
                // Aggiorna il tonnellaggio (solo in modalità standard)
                if (!window.isGuidedMode) {
                    calculateTotalTonnageForDay(dayId);
                    updateTonnageDisplay();
                }

                // 2. Prepara la struttura completa del documento per l'aggiornamento
                const dataToSave = {
                    dayId: dayId,
                    dayName: currentDay.name,
                    exercises: currentDay.exercises.map(ex => ({
                        name: ex.name,
                        sets: ex.sets,
                        reps: ex.reps,
                        rest: ex.rest,
                        defaultWeight: ex.defaultWeight,
                        imageUrl: ex.imageUrl,
                        logged_weights: ex.logged_weights, // Salva i pesi loggati
                        logged_notes: ex.logged_notes || "" // Salva le note loggate
                    }))
                };

                await setDoc(docRef, dataToSave, { merge: false });
                
                showTemporaryMessage('Peso salvato con successo!', 'bg-green-600');

            } catch (error) {
                console.error("Errore nel salvataggio del peso:", error);
                showTemporaryMessage(`Errore di salvataggio: ${error.message}`, 'bg-red-500');
            }
        }
        window.saveWeight = saveWeight; // Esposto globalmente
        
        /**
         * Salva una singola nota su Firestore.
         */
        async function saveNote(dayId, exIndex, note) {
            if (!window.isPersistenceEnabled) {
                 showTemporaryMessage('ATTENZIONE: La persistenza è disabilitata. La nota non sarà salvata.', 'bg-red-500');
                 return;
            }
            const docRef = getLogDocumentRef(dayId);
            if (!docRef || !window.userId) {
                showTemporaryMessage('Errore: Utente non autenticato o DB non pronto.', 'bg-red-500');
                return;
            }
            try {
                const currentDay = window.workoutDays[dayId];
                if (!currentDay) throw new Error("Giorno di allenamento non trovato.");

                // Aggiorna lo stato in memoria
                currentDay.exercises[exIndex].logged_notes = note;
                
                // Prepara la struttura completa del documento per l'aggiornamento
                const dataToSave = {
                    dayId: dayId,
                    dayName: currentDay.name,
                    exercises: currentDay.exercises.map(ex => ({
                        name: ex.name,
                        sets: ex.sets,
                        reps: ex.reps,
                        rest: ex.rest,
                        defaultWeight: ex.defaultWeight,
                        imageUrl: ex.imageUrl,
                        logged_weights: ex.logged_weights || {},
                        logged_notes: ex.logged_notes || "" 
                    }))
                };
                await setDoc(docRef, dataToSave, { merge: false });
                showTemporaryMessage('Nota salvata con successo!', 'bg-green-600');
            } catch (error) {
                console.error("Errore nel salvataggio della nota:", error);
                showTemporaryMessage(`Errore di salvataggio nota: ${error.message}`, 'bg-red-500');
            }
        }
        window.saveNote = saveNote; // Esposto globalmente


        // Funzione per mostrare messaggi temporanei
        function showTemporaryMessage(message, colorClass) {
            const statusMessage = document.getElementById('status-message');
            const originalText = statusMessage.textContent;
            const originalClass = statusMessage.className;

            statusMessage.textContent = message;
            statusMessage.className = `text-sm font-medium text-white p-2 rounded ${colorClass}`;

            // Ripristina dopo 3 secondi
            setTimeout(() => {
                if (statusMessage.textContent === message) {
                    statusMessage.textContent = originalText;
                    statusMessage.className = originalClass;
                }
            }, 3000);
        }

        // --- INTEGRAZIONE GEMINI AI (Omessa per brevità, codice invariato) ---
        // ... (Il codice di generateExerciseTip rimane invariato)

        async function generateExerciseTip(exerciseName, exerciseElement) {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const button = document.getElementById(`tip-btn-${exerciseElement.id.replace('tip-output-', '')}`);
            if (button) button.disabled = true;

            exerciseElement.innerHTML = '<span class="text-yellow-400">Analisi in corso... ✨</span>';

            const systemPrompt = "Sei un personal trainer esperto e conciso. Fornisci un breve consiglio in italiano sulla corretta esecuzione dell'esercizio e indica i principali muscoli coinvolti, massimo 100 parole.";
            const userQuery = `Fornisci un consiglio per l'esercizio: ${exerciseName}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                tools: [{ "google_search": {} }] 
            };

            try {
                let response;
                let attempt = 0;
                const MAX_ATTEMPTS = 3;

                while (attempt < MAX_ATTEMPTS) {
                    attempt++;
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) break;
                        if (response.status === 429) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);

                    } catch (e) {
                        if (attempt === MAX_ATTEMPTS) throw e;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Nessun consiglio generato.';
                
                let sourceHtml = '';
                const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => ({
                            uri: attr.web?.uri,
                            title: attr.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (sources.length > 0) {
                        sourceHtml = `
                            <p class="text-xs text-gray-500 mt-2 italic border-t border-gray-700 pt-2">
                                Fonte: <a href="${sources[0].uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition duration-150">${sources[0].title}</a>
                            </p>
                        `;
                    }
                }

                exerciseElement.innerHTML = `
                    <p class="text-sm text-gray-300 whitespace-pre-wrap">${text}</p>
                    ${sourceHtml}
                `;

            } catch (error) {
                console.error("Errore Gemini API:", error);
                exerciseElement.innerHTML = `Errore API: Impossibile generare il consiglio. Riprova più tardi.`;
            } finally {
                if (button) button.disabled = false;
            }
        }
        window.generateExerciseTip = generateExerciseTip; 

        // --- FUNZIONI UTILITY ---

        /**
         * Restituisce l'URL dell'immagine per un esercizio.
         */
        function getImageUrl(exercise) {
            return exercise.imageUrl || `https://placehold.co/400x200/800080/ffffff/png?text=IMMAGINE+PER+${encodeURIComponent(exercise.name.toUpperCase().replace(/\s/g, '+'))}`;
        }
        
        /**
         * Calcola il tonnellaggio per una singola serie.
         */
        function calculateTonnageForSet(repsString, weight) {
            const w = parseFloat(weight);
            if (isNaN(w) || w === null || w <= 0) {
                return 0;
            }
            
            let repsMatch = repsString.match(/(\d+)/);
            let reps = repsMatch ? parseInt(repsMatch[1], 10) : 1; 

            if (repsString.includes('-') && repsMatch) {
                const parts = repsString.split('-').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
                if (parts.length === 2) {
                    reps = Math.floor((parts[0] + parts[1]) / 2); // Usa la media
                }
            }
            
            return 1 * reps * w;
        }
        window.calculateTonnageForSet = calculateTonnageForSet;

        /**
         * Calcola il tonnellaggio totale per il giorno corrente e aggiorna la variabile globale.
         */
        function calculateTotalTonnageForDay(dayId) {
            window.totalTonnage = 0;
            const currentDay = window.workoutDays[dayId];
            if (!currentDay) return;

            currentDay.exercises.forEach(ex => {
                if (ex.logged_weights) {
                    for (const sKey in ex.logged_weights) {
                        window.totalTonnage += calculateTonnageForSet(ex.reps, ex.logged_weights[sKey]);
                    }
                }
            });
        }
        window.calculateTotalTonnageForDay = calculateTotalTonnageForDay;

        /**
         * Aggiorna il display del tonnellaggio totale.
         */
        function updateTonnageDisplay() {
            const tonnageElement = document.getElementById('total-tonnage-display');
            if (tonnageElement) {
                tonnageElement.textContent = `Tonnellaggio: ${Math.round(window.totalTonnage).toLocaleString('it-IT')} kg`;
                tonnageElement.classList.remove('hidden');
            }
        }
        window.updateTonnageDisplay = updateTonnageDisplay;
        

        // --- LOGICA TIMER/CRONOMETRO (Omessa per brevità, codice invariato) ---
        
        let activeTimers = {}; 
        let isRestPeriodActive = false; 

        function getRestTimeSeconds(restString) {
            const match = restString.match(/(\d+)/);
            return match ? parseInt(match[1], 10) : 0;
        }

        function updateTimerDisplay(timerId, seconds, isGuided = false) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const displayElement = document.getElementById(timerId);
            
            if (!displayElement) return;

            displayElement.textContent = display;

            const button = document.getElementById(timerId.replace('timer-display', 'timer-button'));
            const terminateButton = document.getElementById(timerId.replace('timer-display', 'terminate-button'));
            const timerState = activeTimers[timerId];
            
            if (seconds > 0) {
                 displayElement.classList.remove('text-green-500', 'font-bold');
                 displayElement.classList.add('text-white');
				 
                 if (seconds <= 5) {
                    displayElement.classList.add('text-red-500');
                 } else {
                    displayElement.classList.remove('text-red-500');
                 }

                 if (button) {
                     button.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-green-600', 'hover:bg-green-700', 'bg-red-600');

                     if (timerState && timerState.isRunning) {
                         button.textContent = `RIPOSO IN CORSO`;
                         button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                         if (terminateButton) terminateButton.classList.remove('hidden');
                     } else {
                         button.textContent = 'Avvia Riposo';
                         button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                         if (terminateButton) terminateButton.classList.add('hidden');
                     }
                 }

            } else {
                displayElement.textContent = '00:00'; 
					
                displayElement.classList.remove('text-white', 'text-red-500');
                displayElement.classList.add('font-bold', 'text-green-500');
                
                if (terminateButton) terminateButton.classList.add('hidden');

                if (button) {
                     button.textContent = isGuided ? 'PROSSIMA SERIE/ESERCIZIO' : 'Avvia Riposo';
                     button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-blue-600', 'hover:bg-blue-700');
                     button.classList.add('bg-green-600', 'hover:bg-green-700');
                }

                if (isGuided && isRestPeriodActive) {
                    isRestPeriodActive = false;
                    showTemporaryMessage('Riposo terminato! Pronto per il prossimo passo.', 'bg-green-600');
                    if ('vibrate' in navigator) { 
                        navigator.vibrate(500); 
                    }
                }
            }
        }

        function startTimer(dayId, exIndex, restString, isGuided = false) {
            const timerId = `timer-display-${dayId}-${exIndex}`;
            const durationSeconds = getRestTimeSeconds(restString);

            if (durationSeconds <= 0) {
                if (isGuided) {
                    nextStep(); 
                } else {
                    showTemporaryMessage(`Nessun tempo di riposo specificato per questo esercizio.`, 'bg-red-500');
                }
                return;
            }
            
            if (activeTimers[timerId] && activeTimers[timerId].interval) {
                clearInterval(activeTimers[timerId].interval);
            }
            
            activeTimers[timerId] = {
                seconds: durationSeconds,
                isRunning: true,
                interval: null,
            };
            isRestPeriodActive = true; 

            const interval = setInterval(() => {
                if (activeTimers[timerId].isRunning) { 
                    activeTimers[timerId].seconds--;

                    updateTimerDisplay(timerId, activeTimers[timerId].seconds, isGuided);

                    if (activeTimers[timerId].seconds <= 0) {
                        clearInterval(interval);
                        activeTimers[timerId].isRunning = false;
                        activeTimers[timerId].interval = null;
                    }
                }
            }, 1000);
            
            activeTimers[timerId].interval = interval;
            showTemporaryMessage(`Riposo di ${durationSeconds} secondi iniziato.`, 'bg-blue-600');
            updateTimerDisplay(timerId, durationSeconds, isGuided);
        }

        function startTotalTimer() {
            if (window.totalTimerInterval) {
                clearInterval(window.totalTimerInterval);
            }
            window.totalTimeSeconds = 0;

            const timerElement = document.getElementById('total-timer');
            if (timerElement) {
                timerElement.classList.remove('hidden', 'font-extrabold', 'text-xl');
                timerElement.classList.add('text-lg');
                timerElement.textContent = 'Durata totale: 00:00:00';
            }

            window.totalTimerInterval = setInterval(() => {
                window.totalTimeSeconds++;
                const hours = Math.floor(window.totalTimeSeconds / 3600);
                const minutes = Math.floor((window.totalTimeSeconds % 3600) / 60);
                const seconds = window.totalTimeSeconds % 60;

                const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timerElement) {
                    timerElement.textContent = `Durata totale: ${display}`;
                }
            }, 1000);
        }

        function stopTotalTimer() {
            if (window.totalTimerInterval) {
                clearInterval(window.totalTimerInterval);
                window.totalTimerInterval = null;
            }

            const hours = Math.floor(window.totalTimeSeconds / 3600);
            const minutes = Math.floor((window.totalTimeSeconds % 3600) / 60);
            const seconds = window.totalTimeSeconds % 60;
            const finalTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElement = document.getElementById('total-timer');
            if (timerElement) {
                timerElement.textContent = `Durata finale: ${finalTime}`;
                timerElement.classList.remove('text-lg');
                timerElement.classList.add('font-extrabold', 'text-xl');
            }
        }

        function terminateRest(dayId, exIndex) {
            const timerId = `timer-display-${dayId}-${exIndex}`;
            const timerState = activeTimers[timerId];

            if (timerState && timerState.interval) {
                clearInterval(timerState.interval);
                timerState.interval = null;
                timerState.isRunning = false;
                timerState.seconds = 0; 
                isRestPeriodActive = false;
                
                showTemporaryMessage('Riposo terminato in anticipo. Avanti il prossimo passo!', 'bg-yellow-600');
                updateTimerDisplay(timerId, 0, true); 
            }
        }
        window.terminateRest = terminateRest;

        function toggleTimer(dayId, exIndex, restString, isGuided = false) {
            const timerId = `timer-display-${dayId}-${exIndex}`;
            const durationSeconds = getRestTimeSeconds(restString);

            if (durationSeconds <= 0) {
                if (isGuided) nextStep();
                return;
            }

            const timerState = activeTimers[timerId];
            
            if (!timerState || !timerState.isRunning) {
                if (timerState && timerState.seconds <= 0 && isGuided) {
                    nextStep();
                } else {
                    startTimer(dayId, exIndex, restString, isGuided);
                }
                return;
            }
        }
        
        window.toggleTimer = toggleTimer;


        // --- LOGICA MODALITÀ GUIDATA ---

        function startGuidedMode() {
            window.isGuidedMode = true;
            window.currentExIndex = 0;
            window.currentSet = 1;
            window.totalTonnage = 0; 
            window.exerciseTonnageMap = {}; 
            
            startTotalTimer(); 
			
            document.getElementById('day-tabs').classList.add('hidden');
            document.getElementById('mode-toggle-button').classList.add('hidden');
            document.getElementById('guided-controls-container').classList.remove('hidden'); 
            
            updateTonnageDisplay(); 

            renderGuidedMode();
            showTemporaryMessage('Modalità Guidata avviata. Inizia il tuo allenamento!', 'bg-blue-600');
        }
        window.startGuidedMode = startGuidedMode;

        function stopGuidedMode() {
			stopTotalTimer();
            window.isGuidedMode = false;
            window.currentExIndex = 0;
            window.currentSet = 1;
            window.totalTonnage = 0; 
            window.exerciseTonnageMap = {}; 
            isRestPeriodActive = false;
            
            for (const timerId in activeTimers) {
                 if (activeTimers[timerId] && activeTimers[timerId].interval) {
                    clearInterval(activeTimers[timerId].interval);
                 }
            }
            activeTimers = {}; 

            document.getElementById('day-tabs').classList.remove('hidden');
            document.getElementById('mode-toggle-button').classList.remove('hidden');
            document.getElementById('guided-controls-container').classList.add('hidden'); 
            
            renderDay(window.activeDay);
        }
        window.stopGuidedMode = stopGuidedMode;


        function nextStep() {
            const dayData = window.workoutDays[window.activeDay];
            const currentExercise = dayData.exercises[window.currentExIndex];
            const setKey = `set_${window.currentSet}`;
            
            const isTimedExercise = currentExercise.sets === 0 || currentExercise.rest === "N/A" || !currentExercise.sets;
            
            if (!isTimedExercise) {
                const inputElement = document.getElementById(`${window.activeDay}-${window.currentExIndex}-${window.currentSet - 1}`);
                let weight = null;
                
                // Leggi il valore dall'input in tempo reale se esiste
                if (inputElement) {
                    weight = parseFloat(inputElement.value);
                }
                
                // Se il peso è stato loggato (o l'input è vuoto ma è stato salvato qualcosa in precedenza), usa il valore in memoria
                if ((weight === null || isNaN(weight)) && currentExercise.logged_weights[setKey] !== undefined) {
                     weight = parseFloat(currentExercise.logged_weights[setKey]);
                }

                // Esegui un salvataggio forzato del peso prima di avanzare, se è un valore modificato e non salvato
                if (inputElement && inputElement.value !== currentExercise.logged_weights[setKey]) {
                    saveWeight(window.activeDay, window.currentExIndex, window.currentSet - 1, inputElement.value);
                }

                // Calcola e somma SOLO se è stato loggato un peso valido (> 0)
                if (weight !== null && weight > 0) {
                    const tonnage = calculateTonnageForSet(currentExercise.reps, weight);
                    window.totalTonnage += tonnage;
                    window.exerciseTonnageMap[window.currentExIndex] = (window.exerciseTonnageMap[window.currentExIndex] || 0) + tonnage;
                    updateTonnageDisplay();
                } else {
                    // Mostra un avviso se non c'è peso, ma non bloccare il flow
                    showTemporaryMessage('Attenzione: Peso non loggato. Tonnellaggio non calcolato.', 'bg-red-500');
                }
            }

            // Resetta lo stato del timer per l'esercizio corrente
            const timerId = `timer-display-${window.activeDay}-${window.currentExIndex}`;
            if (activeTimers[timerId] && activeTimers[timerId].interval) {
                clearInterval(activeTimers[timerId].interval);
            }
            activeTimers[timerId] = null; 

            // 2. Controlla se ci sono altre serie per l'esercizio corrente
            if (!isTimedExercise && window.currentSet < currentExercise.sets) {
                window.currentSet++;
                showTemporaryMessage(`Prossima serie: ${window.currentSet} di ${currentExercise.sets}. Inizia la tua serie.`, 'bg-blue-600');
                renderGuidedMode(); 
                return;
            }
            
            // 3. Passa all'esercizio successivo
            const nextExIndex = window.currentExIndex + 1;
            
            if (nextExIndex < dayData.exercises.length) {
                window.currentExIndex = nextExIndex;
                window.currentSet = 1; 
                showTemporaryMessage(`Esercizio successivo: ${dayData.exercises[nextExIndex].name}.`, 'bg-green-600');
                renderGuidedMode();
                return;
            }

            // 4. Fine dell'allenamento
            stopTotalTimer(); 
            showTemporaryMessage(`Allenamento terminato in ${document.getElementById('total-timer').textContent.split(': ').pop()}!`, 'bg-purple-600');

            document.getElementById('workout-content').innerHTML = `
                <div class="p-8 text-center bg-gray-700 rounded-xl shadow-2xl">
                    <h2 class="text-4xl font-extrabold text-green-400 mb-4">🏆 ALLENAMENTO COMPLETATO! 🥳</h2>
                    <p class="text-xl text-gray-300">Complimenti! Hai completato tutti gli esercizi per ${dayData.name}.</p>
                    <p class="text-2xl font-extrabold text-yellow-400 mt-4">Volume Totale: ${Math.round(window.totalTonnage).toLocaleString('it-IT')} kg</p>
					<p id="final-time-display" class="text-2xl font-extrabold text-white mt-4">${document.getElementById('total-timer').textContent}</p>
                    <button onclick="window.stopGuidedMode()" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition duration-150 shadow-lg">
                        Torna alla Visualizzazione Completa
                    </button>
                </div>
            `;
            window.isGuidedMode = false;
            window.currentExIndex = 0;
            window.currentSet = 1;
            isRestPeriodActive = false;
            document.getElementById('guided-controls-container').classList.add('hidden'); 
        }
		
        window.nextStep = nextStep;
										 


        function renderGuidedMode() {
            const dayData = window.workoutDays[window.activeDay];
            const contentDiv = document.getElementById('workout-content');

            if (window.currentExIndex >= dayData.exercises.length) {
                nextStep(); 
                return;
            }
            
            const exercise = dayData.exercises[window.currentExIndex];
            const exIndex = window.currentExIndex;
            const restSeconds = getRestTimeSeconds(exercise.rest);
            const timerId = `timer-display-${window.activeDay}-${exIndex}`;
            
            const isTimedExercise = exercise.sets === 0 || exercise.rest === "N/A" || !exercise.sets;

            if (isTimedExercise) {
                window.currentSet = 1; 
            }

            const setKey = `set_${window.currentSet}`;
            const currentWeight = (exercise.logged_weights && exercise.logged_weights[setKey] !== undefined && exercise.logged_weights[setKey] !== null)
                ? exercise.logged_weights[setKey]
                : exercise.defaultWeight || ''; 

            const currentExTonnage = Math.round(window.exerciseTonnageMap[exIndex] || 0);

            const isTimerRunning = activeTimers[timerId] && activeTimers[timerId].isRunning && activeTimers[timerId].seconds > 0;
            
            const nextStepAction = (isTimerRunning || isTimedExercise) ? 'window.nextStep()' : `window.toggleTimer('${window.activeDay}', ${exIndex}, '${exercise.rest}', true)`;
            
            // --- UI per Esercizio Corrente ---
            let html = `
                <div class="bg-gray-800 p-6 mb-6 rounded-xl shadow-2xl border-4 border-blue-500/50">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                        <h3 class="text-3xl font-extrabold text-white">${exercise.name}</h3>
                        ${!isTimedExercise ? `
                            <span class="text-4xl font-mono font-bold text-yellow-400 p-2 bg-gray-700 rounded-lg">
                                ${window.currentSet}/${exercise.sets}
                            </span>
                        ` : ''}
                    </div>

                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex-shrink-0 w-full md:w-1/2">
                            <img src="${getImageUrl(exercise)}" alt="Immagine di ${exercise.name}"
                                 onerror="this.onerror=null; this.src='https://placehold.co/400x200/800080/ffffff/png?text=IMMAGINE+NON+DISPONIBILE';"
                                 class="w-full h-auto object-cover rounded-lg border border-gray-600 shadow-md aspect-[4/3]">
                            
                            ${!isTimedExercise ? `
                                <div class="mt-4 p-4 bg-gray-900 rounded-xl">
                                    <label for="${window.activeDay}-${exIndex}-${window.currentSet - 1}" class="text-sm font-semibold mb-2 block text-yellow-300">
                                        Peso per Serie ${window.currentSet} (Reps: ${exercise.reps})
                                    </label>
                                    <input type="number" step="0.5" value="${currentWeight}"
                                           onchange="window.saveWeight('${window.activeDay}', ${exIndex}, ${window.currentSet - 1}, this.value)"
                                           id="${window.activeDay}-${exIndex}-${window.currentSet - 1}"
                                           class="w-full p-3 text-2xl text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-center"
                                           placeholder="Peso (kg)">
                                    
                                    <p class="text-sm text-gray-400 mt-2 text-center">
                                        Tonnellaggio attuale esercizio: <span class="text-green-400 font-bold">${currentExTonnage.toLocaleString('it-IT')} kg</span>
                                    </p>
                                </div>
                            ` : `
                                <div class="mt-4 p-4 bg-gray-700 rounded-xl text-center">
                                    <p class="text-lg font-bold text-green-400">DURATA: ${exercise.reps}</p>
                                    <button onclick="window.nextStep()" class="mt-4 px-4 py-2 bg-green-600 text-white font-semibold rounded-full hover:bg-green-700 transition duration-150 shadow-lg">
                                        COMPLETATO (Passa al Prossimo)
                                    </button>
                                </div>
                            `}
                        </div>

                        <div class="flex-grow flex flex-col justify-start">
                            <p class="text-base text-gray-300 mb-4">
                                ${isTimedExercise ? `Concentrati sul mantenimento del ritmo o dell'intensità per la durata di ${exercise.reps}.` : `Esegui la tua ${window.currentSet}a serie. Concentrati sulla forma per ${exercise.reps} ripetizioni.`}
                            </p>
                            
                            <div class="mb-6">
                                <button id="tip-btn-${window.activeDay}-${exIndex}" 
                                        onclick="generateExerciseTip('${exercise.name}', document.getElementById('tip-output-${window.activeDay}-${exIndex}'))"
                                        class="w-full px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                    ✨ Consiglio Esecuzione (AI)
                                </button>
                                <div id="tip-output-${window.activeDay}-${exIndex}" class="p-3 mt-2 bg-gray-900 rounded-lg text-gray-400 min-h-[50px] flex items-center">
                                    <span class="text-xs">${exercise.notes ? `Nota Predefinita: ${exercise.notes}` : 'Clicca per un consiglio sul corretto svolgimento.'}</span>
                                </div>
                            </div>
                            
                            ${!isTimedExercise ? `
                                <p class="text-sm text-gray-400 mt-auto">Recupero Previsto: <span class="text-yellow-300 font-semibold">${exercise.rest}</span></p>
                                <div class="mt-2 flex items-center gap-3">
                                    <button id="timer-button-${window.activeDay}-${exIndex}" 
                                            onclick="window.toggleTimer('${window.activeDay}', ${exIndex}, '${exercise.rest}', true)"
                                            class="px-4 py-3 bg-indigo-600 text-white font-bold rounded-full hover:bg-indigo-700 transition duration-150 shadow-lg flex-grow disabled:opacity-50">
                                        Avvia Riposo
                                    </button>
                                    <span id="${timerId}" class="text-4xl font-mono tracking-wider text-white flex-shrink-0 min-w-[90px] text-right">
                                        ${String(Math.floor(restSeconds / 60)).padStart(2, '0')}:${String(restSeconds % 60).padStart(2, '0')}
                                    </span>
                                </div>
                                
                                <button id="terminate-button-${window.activeDay}-${exIndex}"
                                        onclick="window.terminateRest('${window.activeDay}', ${exIndex})"
                                        class="hidden mt-2 px-4 py-2 bg-red-700 text-white font-semibold rounded-full hover:bg-red-800 transition duration-150 shadow-md">
                                    Termina in Anticipo
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="mt-6 border-t border-gray-700 pt-4">
                        <label for="notes-guided-${exIndex}" class="font-bold mb-2 block text-sm text-white">
                            Note Personali per l'Esercizio:
                        </label>
                        <textarea id="notes-guided-${exIndex}" rows="1" 
                                placeholder="${exercise.notes || 'Aggiungi note personali su esecuzione, sensazioni... (Es. presa stretta, cedimento)'}"
                                onchange="window.saveNote('${window.activeDay}', ${exIndex}, this.value)"
                                class="w-full p-3 text-sm text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner">
                                ${(exercise.logged_notes && exercise.logged_notes.trim()) ? exercise.logged_notes : ''}
                        </textarea>
                    </div>

                </div>
            `;

            contentDiv.innerHTML = html;
            
            if (!isTimedExercise) {
                updateTimerDisplay(timerId, activeTimers[timerId] ? activeTimers[timerId].seconds : restSeconds, true);
            }
        }


        function switchDay(newDayId) {
            if (window.isGuidedMode) {
                stopGuidedMode();
            }

            if (window.activeDay === newDayId) return;
            window.activeDay = newDayId;
            
            calculateTotalTonnageForDay(newDayId);
            updateTonnageDisplay();
            
            renderDay(newDayId);
            
            if (window.isPersistenceEnabled) {
                startDataListener(newDayId); 
            }

            document.querySelectorAll('.day-tab').forEach(tab => {
                if (tab.dataset.day === newDayId) {
                    tab.classList.remove('text-gray-400', 'border-transparent');
                    tab.classList.add('text-white', 'border-blue-500', 'bg-gray-800');
                } else {
                    tab.classList.remove('text-white', 'border-blue-500', 'bg-gray-800');
                    tab.classList.add('text-gray-400', 'border-transparent');
                }
            });
        }
        window.switchDay = switchDay;

        function renderDay(dayId) {
            const dayData = window.workoutDays[dayId];
            const contentDiv = document.getElementById('workout-content');

            document.getElementById('mode-toggle-button').classList.remove('hidden');
            document.getElementById('guided-controls-container').classList.add('hidden'); 
            document.getElementById('day-tabs').classList.remove('hidden');
			document.getElementById('total-timer').classList.add('hidden'); 

            if (!dayData) {
                contentDiv.innerHTML = '<p class="text-red-500">Giorno di allenamento non trovato.</p>';
                return;
            }

            let html = `<h2 class="text-3xl font-bold mb-6 text-blue-400">${dayData.name}</h2>`;

            dayData.exercises.forEach((exercise, exIndex) => {
                const restSeconds = getRestTimeSeconds(exercise.rest);
                const timerId = `timer-display-${dayId}-${exIndex}`;
                
                const isTimedExercise = exercise.sets === 0 || exercise.rest === "N/A" || !exercise.sets;

                // Card Esercizio
                html += `
                <div class="bg-gray-800 p-4 mb-6 rounded-xl shadow-lg border border-gray-700 transform transition-transform duration-300 hover:scale-[1.005]">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-shrink-0 w-full md:w-1/3">
                            <img src="${getImageUrl(exercise)}" alt="Immagine di ${exercise.name}"
                                 onerror="this.onerror=null; this.src='https://placehold.co/400x200/800080/ffffff/png?text=LINK+NON+PUBBLICO!+Carica+un+link+diretto';"
                                 class="w-full h-auto object-cover rounded-lg border border-gray-600 shadow-md aspect-[4/3]">
                        </div>
                        <div class="flex-grow flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-bold mb-1 text-white">${exercise.name}</h3>
                                <p class="text-sm text-gray-400">Ripetizioni/Durata: <span class="text-blue-300 font-semibold">${exercise.reps}</span></p>
                            </div>
                            
                            ${!isTimedExercise ? `
                                <div class="mt-4">
                                    <p class="text-sm text-gray-400">Recupero Previsto: <span class="text-yellow-300 font-semibold">${exercise.rest}</span></p>
                                    <div class="mt-3 flex items-center gap-3">
                                        <button id="timer-button-${dayId}-${exIndex}" 
                                                onclick="window.toggleTimer('${dayId}', ${exIndex}, '${exercise.rest}')"
                                                class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-full hover:bg-indigo-700 transition duration-150 shadow-md flex-grow md:flex-grow-0 disabled:opacity-50">
                                            Avvia Riposo
                                        </button>
                                        <span id="${timerId}" class="text-3xl font-mono tracking-wider text-white flex-shrink-0 min-w-[90px] text-right">
                                            ${String(Math.floor(restSeconds / 60)).padStart(2, '0')}:${String(restSeconds % 60).padStart(2, '0')}
                                        </span>
                                    </div>
                                </div>
                            ` : `
                                <p class="text-sm text-gray-400 mt-2 p-3 bg-gray-700 rounded-lg">
                                    Modalità: <span class="text-green-400 font-bold">Continuo / Durata (Non a Serie)</span>
                                </p>
                            `}
                        </div>
                    </div>

                    <div class="mt-6 border-t border-gray-700 pt-4">
                        <p class="font-medium mb-2 text-gray-300">Consiglio del Personal Trainer AI:</p>
                        <div class="flex flex-col gap-3">
                            <button id="tip-btn-${dayId}-${exIndex}" 
                                    onclick="generateExerciseTip('${exercise.name}', document.getElementById('tip-output-${dayId}-${exIndex}'))"
                                    class="w-full px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                ✨ Chiedi un Tip sull'Esecuzione
                            </button>
                            <div id="tip-output-${dayId}-${exIndex}" class="p-3 bg-gray-900 rounded-lg flex-grow text-gray-400 w-full min-h-[50px] flex items-center">
                                <span class="text-xs">${exercise.notes ? `Nota Predefinita: ${exercise.notes}` : 'Clicca per un consiglio sul corretto svolgimento.'}</span>
                            </div>
                        </div>
                    </div>


                    ${!isTimedExercise ? `
                        <div class="mt-6 border-t border-gray-700 pt-4">
                    ` : ''}
                `;

                if (!isTimedExercise) {
                    const prevSetWeight = (exercise.logged_weights && exercise.logged_weights['set_1'] !== undefined && exercise.logged_weights['set_1'] !== null)
                        ? exercise.logged_weights['set_1']
                        : exercise.defaultWeight || 'N/A';
                    
                    html += `
                        <p class="text-sm font-semibold mb-3 text-gray-400">
                            Peso Ultima Serie Loggata (Set 1): <span class="text-indigo-400 font-extrabold">${prevSetWeight} kg</span>
                        </p>
                        <p class="font-bold mb-3 text-lg text-yellow-400">Log Pesi (in kg):</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    `;
                    for (let setIndex = 0; setIndex < exercise.sets; setIndex++) {
                        const setKey = `set_${setIndex + 1}`;
                        const currentWeight = (exercise.logged_weights && exercise.logged_weights[setKey] !== undefined && exercise.logged_weights[setKey] !== null)
                            ? exercise.logged_weights[setKey]
                            : exercise.defaultWeight || ''; 

                        html += `
                            <div class="flex flex-col relative">
                                <label for="${dayId}-${exIndex}-${setIndex}" class="text-xs font-semibold mb-1 text-gray-400">
                                    Serie ${setIndex + 1} (${exercise.reps})
                                </label>
                                <input type="number" step="0.5" value="${currentWeight}"
                                       onchange="window.saveWeight('${dayId}', ${exIndex}, ${setIndex}, this.value)"
                                       id="${dayId}-${exIndex}-${setIndex}"
                                       class="w-full p-3 text-lg text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner"
                                       placeholder="Peso (kg)">
                            </div>
                        `;
                    }
                }

                html += `
                    ${!isTimedExercise ? `
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-6 border-t border-gray-700 pt-4">
                        <label for="notes-${dayId}-${exIndex}" class="font-bold mb-2 block text-sm text-white">
                            Note Personali:
                        </label>
                        <textarea id="notes-${dayId}-${exIndex}" rows="1" 
                                placeholder="${exercise.notes || 'Aggiungi note personali su esecuzione, sensazioni, o modifiche... (Es. presa stretta, cedimento alla 8a rip.)'}"
                                onchange="window.saveNote('${dayId}', ${exIndex}, this.value)"
                                class="w-full p-3 text-sm text-white bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner">
                                ${(exercise.logged_notes && exercise.logged_notes.trim()) ? exercise.logged_notes : ''}
                        </textarea>
                    </div>

                </div>
                `;
            });

            contentDiv.innerHTML = html;
        }
        
        // --- SETUP INIZIALIALE ---
        document.addEventListener('DOMContentLoaded', () => {
            // Render tabs
            const tabsContainer = document.getElementById('day-tabs');
            let tabsHtml = '';
            let isFirst = true;
            for (const [dayId, data] of Object.entries(window.workoutDays)) {
                const activeClasses = isFirst ? 'text-white border-blue-500 bg-gray-800' : 'text-gray-400 border-transparent';
                tabsHtml += `
                    <button class="day-tab flex-1 py-3 text-base font-semibold border-b-2 ${activeClasses} transition duration-300 hover:border-blue-500 hover:text-white hover:bg-gray-800/70"
                            data-day="${dayId}" onclick="window.switchDay('${dayId}')">
                        ${data.name.split(':')[0]}
                    </button>
                `;
                isFirst = false;
            }
            tabsContainer.innerHTML = tabsHtml;

            // Inizializza Firebase e avvia tutto
            initializeFirebase();
        });
    </script>
</head>
<body class="min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="text-center mb-8 border-b border-gray-700 pb-4">
            <h1 id="main-title" class="text-4xl font-extrabold text-blue-500 tracking-tight">
                💪 Piano di allenamento Laura
            </h1>
            <p class="text-gray-400 mt-2">Programma di 3 giorni con tracciamento pesi in tempo reale.</p>
        </header>
        
        <div class="mb-6 p-4 bg-gray-800 rounded-xl border border-gray-700">
            <h3 class="text-xl font-bold mb-3 text-yellow-400">Informazioni Personali</h3>
            <div id="personal-info-container">
                <p class="text-sm text-gray-500">Caricamento...</p>
            </div>
        </div>

        <div class="mb-6 p-3 bg-gray-900 rounded-xl border border-gray-700 text-center">
            <p id="status-message" class="text-sm font-medium text-green-400">Inizializzazione in corso...</p>
            <p id="user-id" class="text-xs text-gray-500 mt-1"></p>
        </div>
        
        
        <div id="day-tabs" class="flex justify-around bg-gray-900 rounded-t-xl overflow-hidden border-b-2 border-gray-700 mb-4">
            </div>

        <div class="text-center mb-6">
            <button id="mode-toggle-button" onclick="window.startGuidedMode()" 
                    class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-150 disabled:opacity-50">
                🚀 Avvia Allenamento Guidato
            </button>
            
            <div id="guided-controls-container" class="hidden mt-4 flex flex-col items-center gap-2">
                 <button id="stop-guided-button" onclick="window.stopGuidedMode()" 
                        class="px-6 py-3 bg-yellow-600 text-white font-bold rounded-full shadow-lg hover:bg-yellow-700 transition duration-150">
                    🛑 Termina Allenamento Guidato
                </button>
                <p id="total-tonnage-display" class="mt-2 text-lg font-mono text-green-400 font-bold hidden">Tonnellaggio: 0 kg</p> 
                <p id="total-timer" class="mt-3 text-lg font-mono text-white/80">Durata totale: 00:00:00</p>
            </div>
        </div>

        <div id="workout-content" class="min-h-[500px] p-2">
            <p class="text-center text-gray-500 pt-20">Caricamento del programma...</p>
        </div>

    </div>
</body>
</html>
